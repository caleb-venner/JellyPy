<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JellyPy</title>
    <style>
        .advanced-section {
            margin-top: 30px;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.1);
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #555;
        }
        .section-title {
            font-size: 1.2em;
            font-weight: bold;
        }
        .script-setting-item {
            border: 1px solid #555;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
            background: rgba(255, 255, 255, 0.02);
        }
        .script-setting-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .script-setting-name {
            font-weight: bold;
            font-size: 1.1em;
        }
        .script-setting-controls {
            display: flex;
            gap: 10px;
        }
        .expandable-section {
            margin-top: 10px;
        }
        .expandable-header {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .expandable-header:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        .expandable-content {
            display: none;
            padding: 10px;
            border-left: 2px solid #555;
            margin-left: 10px;
        }
        .expandable-content.expanded {
            display: block;
        }
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .form-grid-full {
            grid-column: 1 / -1;
        }
        .condition-item, .attribute-item {
            border: 1px solid #666;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.03);
        }
        .item-controls {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }
        .trigger-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .hidden {
            display: none !important;
        }
        .small-button {
            font-size: 0.8em;
            padding: 4px 8px;
        }
        .danger-button {
            background-color: #d32f2f !important;
        }
        .tab-container {
            margin-bottom: 20px;
        }
        .tab-buttons {
            display: flex;
            border-bottom: 1px solid #555;
            margin-bottom: 20px;
        }
        .tab-button {
            padding: 10px 20px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            color: #ccc;
            cursor: pointer;
            font-size: 1em;
        }
        .tab-button.active {
            color: #fff;
            border-bottom-color: #00a4dc;
        }
        .tab-button:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div id="JellyPyConfigPage" data-role="page" class="page type-interior pluginConfigurationPage" data-require="emby-input,emby-button,emby-select,emby-checkbox">
        <div data-role="content">
            <div class="content-primary">
                <form id="JellyPyConfigForm">

                    <!-- Tab Navigation -->
                    <div class="tab-container">
                        <div class="tab-buttons">
                            <button type="button" class="tab-button active" onclick="switchTab('advanced')">Script Settings</button>
                            <button type="button" class="tab-button" onclick="switchTab('native')">Native Integration</button>
                            <button type="button" class="tab-button" onclick="switchTab('global')">Global Settings</button>
                        </div>
                    </div>

                    <!-- Script Settings Tab -->
                    <div id="advanced-tab" class="tab-content active" style="display: block;">
                        <div class="section-header">
                            <div class="section-title">Script Settings</div>
                            <button type="button" is="emby-button" class="emby-button" onclick="addScriptSetting()">Add Script Setting</button>
                        </div>
                        <div id="script-settings-container">
                            <!-- Script settings will be dynamically generated here -->
                        </div>
                        <div class="fieldDescription" style="margin-top: 20px;">
                            Create custom script configurations with specific triggers, conditions, and data attributes.
                            Each setting can respond to different Jellyfin events and pass selected data to your scripts.
                        </div>
                    </div>

                    <!-- Native Integration Tab -->
                    <div id="native-tab" class="tab-content" style="display: none;">
                        <div class="section-title" style="margin-bottom: 20px;">Sonarr & Radarr Integration</div>
                        <div class="fieldDescription" style="margin-bottom: 20px;">
                            Configure native integration with Sonarr and Radarr to automatically manage monitoring of TV shows and movies based on playback events.
                        </div>

                        <!-- Sonarr Settings -->
                        <div class="advanced-section">
                            <h3 style="margin-top: 0;">Sonarr Configuration</h3>
                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label class="emby-checkbox-label">
                                    <input id="EnableNativeSonarrIntegration" name="EnableNativeSonarrIntegration" type="checkbox" is="emby-checkbox" />
                                    <span>Enable Sonarr Integration</span>
                                </label>
                                <div class="fieldDescription">Enable automatic TV show monitoring management through Sonarr.</div>
                            </div>
                            <div class="inputContainer">
                                <label class="inputLabel inputLabelUnfocused" for="SonarrUrl">Sonarr URL</label>
                                <input id="SonarrUrl" name="SonarrUrl" type="text" is="emby-input" placeholder="http://localhost:8989" />
                                <div class="fieldDescription">The URL of your Sonarr instance (e.g., http://localhost:8989).</div>
                            </div>
                            <div class="inputContainer">
                                <label class="inputLabel inputLabelUnfocused" for="SonarrApiKey">Sonarr API Key</label>
                                <input id="SonarrApiKey" name="SonarrApiKey" type="password" is="emby-input" />
                                <div class="fieldDescription">Your Sonarr API key (found in Settings → General → Security).</div>
                            </div>
                            <div class="inputContainer">
                                <button id="testSonarrConnection" type="button" is="emby-button" class="raised button-submit" style="margin-bottom: 10px;">
                                    <span id="testSonarrText">Test Sonarr Connection</span>
                                </button>
                                <div id="sonarrTestResult" class="fieldDescription" style="display: none; font-weight: bold;"></div>
                            </div>
                            <div class="inputContainer">
                                <label class="inputLabel inputLabelUnfocused" for="EpisodeDownloadBuffer">Episodes to Monitor</label>
                                <input id="EpisodeDownloadBuffer" name="EpisodeDownloadBuffer" type="number" is="emby-input" min="1" max="20" />
                                <div class="fieldDescription">Number of upcoming episodes to keep monitored after watching an episode (default: 5).</div>
                            </div>
                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label class="emby-checkbox-label">
                                    <input id="AutoSearchEpisodes" name="AutoSearchEpisodes" type="checkbox" is="emby-checkbox" />
                                    <span>Auto-Search Episodes</span>
                                </label>
                                <div class="fieldDescription">Automatically trigger searches for newly monitored episodes in Sonarr.</div>
                            </div>
                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label class="emby-checkbox-label">
                                    <input id="MonitorFutureEpisodes" name="MonitorFutureEpisodes" type="checkbox" is="emby-checkbox" />
                                    <span>Monitor Future Episodes</span>
                                </label>
                                <div class="fieldDescription">Automatically monitor future episodes when they are added to Sonarr.</div>
                            </div>
                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label class="emby-checkbox-label">
                                    <input id="SkipEpisodesWithFiles" name="SkipEpisodesWithFiles" type="checkbox" is="emby-checkbox" />
                                    <span>Skip Episodes With Files</span>
                                </label>
                                <div class="fieldDescription">Only monitor episodes that don't have files yet. Disable to re-monitor all episodes (useful for quality upgrades).</div>
                            </div>
                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label class="emby-checkbox-label">
                                    <input id="UnmonitorWatchedEpisodes" name="UnmonitorWatchedEpisodes" type="checkbox" is="emby-checkbox" />
                                    <span>Unmonitor Watched Episodes</span>
                                </label>
                                <div class="fieldDescription">Unmonitor episodes after they are watched. Disable to keep all episodes monitored.</div>
                            </div>
                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label class="emby-checkbox-label">
                                    <input id="MonitorOnlyCurrentSeason" name="MonitorOnlyCurrentSeason" type="checkbox" is="emby-checkbox" />
                                    <span>Monitor Only Current Season</span>
                                </label>
                                <div class="fieldDescription">When enabled, only monitors episodes in the same season you're currently watching. Future seasons won't be monitored until you start watching them.</div>
                            </div>
                            <div class="inputContainer">
                                <label class="inputLabel inputLabelUnfocused" for="MinimumEpisodeBuffer">Minimum Episode Buffer</label>
                                <input id="MinimumEpisodeBuffer" name="MinimumEpisodeBuffer" type="number" is="emby-input" min="1" max="10" />
                                <div class="fieldDescription">Minimum number of unwatched episodes to maintain. If you have fewer than this, the buffer will be increased (default: 2).</div>
                            </div>
                        </div>

                        <!-- Radarr Settings -->
                        <div class="advanced-section" style="margin-top: 20px;">
                            <h3 style="margin-top: 0;">Radarr Configuration</h3>
                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label class="emby-checkbox-label">
                                    <input id="EnableNativeRadarrIntegration" name="EnableNativeRadarrIntegration" type="checkbox" is="emby-checkbox" />
                                    <span>Enable Radarr Integration</span>
                                </label>
                                <div class="fieldDescription">Enable automatic movie monitoring management through Radarr.</div>
                            </div>
                            <div class="inputContainer">
                                <label class="inputLabel inputLabelUnfocused" for="RadarrUrl">Radarr URL</label>
                                <input id="RadarrUrl" name="RadarrUrl" type="text" is="emby-input" placeholder="http://localhost:7878" />
                                <div class="fieldDescription">The URL of your Radarr instance (e.g., http://localhost:7878).</div>
                            </div>
                            <div class="inputContainer">
                                <label class="inputLabel inputLabelUnfocused" for="RadarrApiKey">Radarr API Key</label>
                                <input id="RadarrApiKey" name="RadarrApiKey" type="password" is="emby-input" />
                                <div class="fieldDescription">Your Radarr API key (found in Settings → General → Security).</div>
                            </div>
                            <div class="inputContainer">
                                <button id="testRadarrConnection" type="button" is="emby-button" class="raised button-submit" style="margin-bottom: 10px;">
                                    <span id="testRadarrText">Test Radarr Connection</span>
                                </button>
                                <div id="radarrTestResult" class="fieldDescription" style="display: none; font-weight: bold;"></div>
                            </div>
                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label class="emby-checkbox-label">
                                    <input id="UnmonitorWatchedMovies" name="UnmonitorWatchedMovies" type="checkbox" is="emby-checkbox" />
                                    <span>Unmonitor Watched Movies</span>
                                </label>
                                <div class="fieldDescription">Automatically set movies to unmonitored in Radarr after they are watched.</div>
                            </div>
                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label class="emby-checkbox-label">
                                    <input id="UnmonitorOnlyIfWatched" name="UnmonitorOnlyIfWatched" type="checkbox" is="emby-checkbox" />
                                    <span>Unmonitor Only If Actually Watched</span>
                                </label>
                                <div class="fieldDescription">Only unmonitor movies if the user watched at least the configured percentage. Requires PlaybackStop event.</div>
                            </div>
                            <div class="inputContainer">
                                <label class="inputLabel inputLabelUnfocused" for="MinimumWatchPercentage">Minimum Watch Percentage</label>
                                <input id="MinimumWatchPercentage" name="MinimumWatchPercentage" type="number" is="emby-input" min="0" max="100" />
                                <div class="fieldDescription">Minimum percentage of the movie that must be watched to consider it "watched" (default: 90).</div>
                            </div>
                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label class="emby-checkbox-label">
                                    <input id="UnmonitorAfterUpgrade" name="UnmonitorAfterUpgrade" type="checkbox" is="emby-checkbox" />
                                    <span>Unmonitor After Quality Cutoff</span>
                                </label>
                                <div class="fieldDescription">Only unmonitor movies that have reached their quality cutoff (no upgrade possible).</div>
                            </div>
                        </div>
                    </div>

                    <!-- Global Settings Tab -->
                    <div id="global-tab" class="tab-content" style="display: none;">
                        <div class="section-title" style="margin-bottom: 20px;">Global Execution Settings</div>
                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="MaxConcurrentExecutions">Max concurrent executions</label>
                            <input id="MaxConcurrentExecutions" name="MaxConcurrentExecutions" type="number" is="emby-input" min="1" max="20" />
                            <div class="fieldDescription">Maximum number of scripts that can run simultaneously.</div>
                        </div>
                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="DefaultTimeoutSeconds">Default timeout (seconds)</label>
                            <input id="DefaultTimeoutSeconds" name="DefaultTimeoutSeconds" type="number" is="emby-input" min="30" />
                            <div class="fieldDescription">Default timeout for script execution when not specified in individual settings.</div>
                        </div>
                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="QueueSize">Queue size</label>
                            <input id="QueueSize" name="QueueSize" type="number" is="emby-input" min="10" />
                            <div class="fieldDescription">Maximum number of pending script executions to queue.</div>
                        </div>
                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label class="emby-checkbox-label">
                                <input id="EnableVerboseLogging" name="EnableVerboseLogging" type="checkbox" is="emby-checkbox" />
                                <span>Enable verbose logging</span>
                            </label>
                            <div class="fieldDescription">Log detailed information about script execution for debugging.</div>
                        </div>
                    </div>

                    <div style="margin-top: 30px;">
                        <button is="emby-button" type="submit" class="raised button-submit block emby-button">
                            <span>Save</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <script type="text/javascript">
            var JellyPyConfig = {
                pluginUniqueId: 'a5bd541f-38dc-467e-9a9a-15fe3f3bcf5c',
                currentConfig: null,
                eventTypes: [
                    'PlaybackStart', 'PlaybackStop', 'PlaybackPause', 'PlaybackResume', 'PlaybackProgress',
                    'ItemAdded', 'ItemUpdated', 'UserCreated', 'UserDeleted'
                ],
                executorTypes: [
                    'Python', 'PowerShell', 'Bash', 'NodeJs', 'Binary'
                ],
                conditionOperators: [
                    'Equals', 'NotEquals', 'Contains', 'NotContains', 'StartsWith', 'EndsWith',
                    'Regex', 'GreaterThan', 'LessThan', 'In', 'NotIn'
                ],
                dataAttributeFormats: [
                    'String', 'Json', 'Environment', 'Argument'
                ],
                availableFields: [
                    'EventType', 'Timestamp', 'UserId', 'UserName', 'SessionId', 'ItemId', 'ItemName',
                    'ItemType', 'ItemPath', 'LibraryId', 'LibraryName', 'PlaybackPositionTicks',
                    'IsPaused', 'ClientName', 'DeviceName', 'DeviceId', 'SeriesName', 'SeasonNumber',
                    'EpisodeNumber', 'Year', 'Genres', 'ContentRating'
                ]
            };

            // Tab Management
            function switchTab(tabName) {
                // Hide all tab contents
                document.querySelectorAll('.tab-content').forEach(function(content) {
                    content.style.display = 'none';
                });

                // Remove active class from all tab buttons
                document.querySelectorAll('.tab-button').forEach(function(button) {
                    button.classList.remove('active');
                });

                // Show the selected tab content
                var targetTab = document.getElementById(tabName + '-tab');
                if (targetTab) {
                    targetTab.style.display = 'block';
                }

                // Add active class to the button that matches this tab
                var targetButton = document.querySelector(".tab-button[onclick*=\"'" + tabName + "'\"]");
                if (targetButton) {
                    targetButton.classList.add('active');
                }
            }

            // Script Settings Management
            function addScriptSetting() {
                var newSetting = {
                    Id: generateGuid(),
                    Name: '',
                    Description: '',
                    Enabled: true,
                    Triggers: [],
                    Conditions: [],
                    Execution: {
                        ExecutorType: 'Python',
                        ExecutablePath: '/usr/bin/python3',
                        ScriptPath: '',
                        WorkingDirectory: '',
                        AdditionalArguments: '',
                        EnvironmentVariables: {},
                        TimeoutSeconds: 300
                    },
                    DataAttributes: [],
                    Priority: 100
                };

                JellyPyConfig.currentConfig.ScriptSettings.push(newSetting);
                renderScriptSettings();
            }

            function deleteScriptSetting(index) {
                if (confirm('Are you sure you want to delete this script setting?')) {
                    JellyPyConfig.currentConfig.ScriptSettings.splice(index, 1);
                    renderScriptSettings();
                }
            }

            function moveScriptSetting(index, direction) {
                var settings = JellyPyConfig.currentConfig.ScriptSettings;
                var newIndex = index + direction;

                if (newIndex < 0 || newIndex >= settings.length) return;

                var temp = settings[index];
                settings[index] = settings[newIndex];
                settings[newIndex] = temp;

                renderScriptSettings();
            }

            function renderScriptSettings() {
                var container = document.getElementById('script-settings-container');
                container.innerHTML = '';

                if (!JellyPyConfig.currentConfig.ScriptSettings || JellyPyConfig.currentConfig.ScriptSettings.length === 0) {
                    container.innerHTML = '<div class="fieldDescription">No script settings configured. Click "Add Script Setting" to create your first custom script configuration.</div>';
                    return;
                }

                JellyPyConfig.currentConfig.ScriptSettings.forEach(function(setting, index) {
                    var settingHtml = createScriptSettingHtml(setting, index);
                    container.appendChild(settingHtml);
                });

                // Populate script dropdowns after HTML is rendered
                JellyPyConfig.currentConfig.ScriptSettings.forEach(function(setting, index) {
                    var selectElement = document.getElementById('scriptSelect-' + index);
                    if (selectElement) {
                        populateScriptDropdown(selectElement, setting.Execution.ScriptPath);
                    }
                });
            }

            function createScriptSettingHtml(setting, index) {
                var div = document.createElement('div');
                div.className = 'script-setting-item';

                // Build HTML using string concatenation instead of template literals
                var html = '<div class="script-setting-header">' +
                    '<div>' +
                        '<div class="script-setting-name">' + escapeHtml(setting.Name || 'Unnamed Script Setting') + '</div>' +
                        '<div class="fieldDescription">' + escapeHtml(setting.Description || 'No description') + '</div>' +
                    '</div>' +
                    '<div class="script-setting-controls">' +
                        '<button type="button" is="emby-button" class="emby-button small-button" onclick="moveScriptSetting(' + index + ', -1)" ' + (index === 0 ? 'disabled' : '') + '>↑</button>' +
                        '<button type="button" is="emby-button" class="emby-button small-button" onclick="moveScriptSetting(' + index + ', 1)" ' + (index === JellyPyConfig.currentConfig.ScriptSettings.length - 1 ? 'disabled' : '') + '>↓</button>' +
                        '<button type="button" is="emby-button" class="emby-button small-button" onclick="toggleScriptSetting(' + index + ')">' + (setting.Enabled ? 'Disable' : 'Enable') + '</button>' +
                        '<button type="button" is="emby-button" class="emby-button small-button danger-button" onclick="deleteScriptSetting(' + index + ')">Delete</button>' +
                    '</div>' +
                '</div>' +

                '<!-- Basic Configuration -->' +
                '<div class="form-grid">' +
                    '<div class="inputContainer">' +
                        '<label class="inputLabel inputLabelUnfocused">Name</label>' +
                        '<input type="text" is="emby-input" value="' + escapeHtml(setting.Name) + '" onchange="updateScriptSetting(' + index + ', \'Name\', this.value)" />' +
                    '</div>' +
                    '<div class="inputContainer">' +
                        '<label class="inputLabel inputLabelUnfocused">Priority</label>' +
                        '<input type="number" is="emby-input" value="' + setting.Priority + '" min="0" onchange="updateScriptSetting(' + index + ', \'Priority\', parseInt(this.value))" />' +
                    '</div>' +
                    '<div class="inputContainer form-grid-full">' +
                        '<label class="inputLabel inputLabelUnfocused">Description</label>' +
                        '<input type="text" is="emby-input" value="' + escapeHtml(setting.Description) + '" onchange="updateScriptSetting(' + index + ', \'Description\', this.value)" />' +
                    '</div>' +
                '</div>' +

                '<!-- Event Triggers -->' +
                '<div class="expandable-section">' +
                    '<div class="expandable-header" onclick="toggleExpandable(this)">' +
                        '<span>▶</span>' +
                        '<span>Event Triggers (' + setting.Triggers.length + ' selected)</span>' +
                    '</div>' +
                    '<div class="expandable-content">' +
                        '<div class="trigger-checkboxes" id="triggers-' + index + '">' +
                            JellyPyConfig.eventTypes.map(function(eventType) {
                                return '<label class="emby-checkbox-label">' +
                                    '<input type="checkbox" is="emby-checkbox" ' + (setting.Triggers.includes(eventType) ? 'checked' : '') +
                                    ' onchange="updateTriggers(' + index + ', \'' + eventType + '\', this.checked)" />' +
                                    '<span>' + eventType + '</span>' +
                                '</label>';
                            }).join('') +
                        '</div>' +
                    '</div>' +
                '</div>' +

                '<!-- Execution Configuration -->' +
                '<div class="expandable-section">' +
                    '<div class="expandable-header" onclick="toggleExpandable(this)">' +
                        '<span>▶</span>' +
                        '<span>Script Execution</span>' +
                    '</div>' +
                    '<div class="expandable-content">' +
                        '<div class="form-grid">' +
                            '<div class="inputContainer">' +
                                '<label class="inputLabel inputLabelUnfocused">Executor Type</label>' +
                                '<select is="emby-select" onchange="updateScriptExecution(' + index + ', \'ExecutorType\', this.value)">' +
                                    JellyPyConfig.executorTypes.map(function(type) {
                                        return '<option value="' + type + '" ' + (setting.Execution.ExecutorType === type ? 'selected' : '') + '>' + type + '</option>';
                                    }).join('') +
                                '</select>' +
                            '</div>' +
                            '<div class="inputContainer">' +
                                '<label class="inputLabel inputLabelUnfocused">Timeout (seconds)</label>' +
                                '<input type="number" is="emby-input" value="' + setting.Execution.TimeoutSeconds + '" min="30" onchange="updateScriptExecution(' + index + ', \'TimeoutSeconds\', parseInt(this.value))" />' +
                            '</div>' +
                            '<div class="inputContainer form-grid-full">' +
                                '<label class="inputLabel inputLabelUnfocused">Executable Path</label>' +
                                '<input type="text" is="emby-input" value="' + escapeHtml(setting.Execution.ExecutablePath) + '" onchange="updateScriptExecution(' + index + ', \'ExecutablePath\', this.value)" />' +
                            '</div>' +
                            '<div class="inputContainer form-grid-full">' +
                                '<label class="inputLabel inputLabelUnfocused">Script</label>' +
                                '<div style="display: flex; gap: 8px; align-items: center;">' +
                                    '<select is="emby-select" style="flex: 1;" onchange="updateScriptExecution(' + index + ', \'ScriptPath\', this.value)" id="scriptSelect-' + index + '">' +
                                        '<option value="">Select a script...</option>' +
                                    '</select>' +
                                    '<button type="button" is="emby-button" class="emby-button small-button" onclick="refreshScripts(' + index + ')">🔄</button>' +
                                    '<button type="button" is="emby-button" class="emby-button small-button" onclick="toggleCustomScriptPath(' + index + ')">✏️</button>' +
                                '</div>' +
                                '<input type="text" is="emby-input" value="' + escapeHtml(setting.Execution.ScriptPath) + '" onchange="updateScriptExecution(' + index + ', \'ScriptPath\', this.value)" style="margin-top: 8px; display: none;" id="customScriptPath-' + index + '" placeholder="Enter custom script path..." />' +
                            '</div>' +
                            '<div class="inputContainer form-grid-full">' +
                                '<label class="inputLabel inputLabelUnfocused">Working Directory</label>' +
                                '<input type="text" is="emby-input" value="' + escapeHtml(setting.Execution.WorkingDirectory) + '" onchange="updateScriptExecution(' + index + ', \'WorkingDirectory\', this.value)" />' +
                            '</div>' +
                            '<div class="inputContainer form-grid-full">' +
                                '<label class="inputLabel inputLabelUnfocused">Additional Arguments</label>' +
                                '<input type="text" is="emby-input" value="' + escapeHtml(setting.Execution.AdditionalArguments) + '" onchange="updateScriptExecution(' + index + ', \'AdditionalArguments\', this.value)" />' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>' +

                '<!-- Execution Conditions -->' +
                '<div class="expandable-section">' +
                    '<div class="expandable-header" onclick="toggleExpandable(this)">' +
                        '<span>▶</span>' +
                        '<span>Execution Conditions (' + setting.Conditions.length + ')</span>' +
                    '</div>' +
                    '<div class="expandable-content">' +
                        '<div id="conditions-' + index + '">' +
                            setting.Conditions.map(function(condition, condIndex) { return createConditionHtml(condition, index, condIndex); }).join('') +
                        '</div>' +
                        '<button type="button" is="emby-button" class="emby-button small-button" onclick="addCondition(' + index + ')">Add Condition</button>' +
                    '</div>' +
                '</div>' +

                '<!-- Data Attributes -->' +
                '<div class="expandable-section">' +
                    '<div class="expandable-header" onclick="toggleExpandable(this)">' +
                        '<span>▶</span>' +
                        '<span>Data Attributes (' + setting.DataAttributes.length + ')</span>' +
                    '</div>' +
                    '<div class="expandable-content">' +
                        '<div id="attributes-' + index + '">' +
                            setting.DataAttributes.map(function(attr, attrIndex) { return createDataAttributeHtml(attr, index, attrIndex); }).join('') +
                        '</div>' +
                        '<button type="button" is="emby-button" class="emby-button small-button" onclick="addDataAttribute(' + index + ')">Add Data Attribute</button>' +
                    '</div>' +
                '</div>';

                div.innerHTML = html;
                return div;
            }

            function createConditionHtml(condition, settingIndex, conditionIndex) {
                var fieldOptions = JellyPyConfig.availableFields.map(function(field) {
                    return '<option value="' + field + '" ' + (condition.Field === field ? 'selected' : '') + '>' + field + '</option>';
                }).join('');

                var operatorOptions = JellyPyConfig.conditionOperators.map(function(op) {
                    return '<option value="' + op + '" ' + (condition.Operator === op ? 'selected' : '') + '>' + op + '</option>';
                }).join('');

                return '<div class="condition-item">' +
                    '<div class="form-grid">' +
                        '<div class="inputContainer">' +
                            '<label class="inputLabel inputLabelUnfocused">Field</label>' +
                            '<select is="emby-select" onchange="updateCondition(' + settingIndex + ', ' + conditionIndex + ', \'Field\', this.value)">' +
                                '<option value="">Select field...</option>' +
                                fieldOptions +
                            '</select>' +
                        '</div>' +
                        '<div class="inputContainer">' +
                            '<label class="inputLabel inputLabelUnfocused">Operator</label>' +
                            '<select is="emby-select" onchange="updateCondition(' + settingIndex + ', ' + conditionIndex + ', \'Operator\', this.value)">' +
                                operatorOptions +
                            '</select>' +
                        '</div>' +
                        '<div class="inputContainer">' +
                            '<label class="inputLabel inputLabelUnfocused">Value</label>' +
                            '<input type="text" is="emby-input" value="' + escapeHtml(condition.Value) + '"' +
                                   ' onchange="updateCondition(' + settingIndex + ', ' + conditionIndex + ', \'Value\', this.value)" />' +
                        '</div>' +
                        '<div class="inputContainer">' +
                            '<label class="emby-checkbox-label">' +
                                '<input type="checkbox" is="emby-checkbox" ' + (condition.CaseSensitive ? 'checked' : '') +
                                       ' onchange="updateCondition(' + settingIndex + ', ' + conditionIndex + ', \'CaseSensitive\', this.checked)" />' +
                                '<span>Case sensitive</span>' +
                            '</label>' +
                        '</div>' +
                    '</div>' +
                    '<div class="item-controls">' +
                        '<button type="button" is="emby-button" class="emby-button small-button danger-button" onclick="removeCondition(' + settingIndex + ', ' + conditionIndex + ')">Remove</button>' +
                    '</div>' +
                '</div>';
            }

            function createDataAttributeHtml(attribute, settingIndex, attributeIndex) {
                var fieldOptions = JellyPyConfig.availableFields.map(function(field) {
                    return '<option value="' + field + '" ' + (attribute.SourceField === field ? 'selected' : '') + '>' + field + '</option>';
                }).join('');

                var formatOptions = JellyPyConfig.dataAttributeFormats.map(function(format) {
                    return '<option value="' + format + '" ' + (attribute.Format === format ? 'selected' : '') + '>' + format + '</option>';
                }).join('');

                return '<div class="attribute-item">' +
                    '<div class="form-grid">' +
                        '<div class="inputContainer">' +
                            '<label class="inputLabel inputLabelUnfocused">Name</label>' +
                            '<input type="text" is="emby-input" value="' + escapeHtml(attribute.Name) + '"' +
                                   ' onchange="updateDataAttribute(' + settingIndex + ', ' + attributeIndex + ', \'Name\', this.value)" />' +
                        '</div>' +
                        '<div class="inputContainer">' +
                            '<label class="inputLabel inputLabelUnfocused">Source Field</label>' +
                            '<select is="emby-select" onchange="updateDataAttribute(' + settingIndex + ', ' + attributeIndex + ', \'SourceField\', this.value)">' +
                                '<option value="">Select field...</option>' +
                                fieldOptions +
                            '</select>' +
                        '</div>' +
                        '<div class="inputContainer">' +
                            '<label class="inputLabel inputLabelUnfocused">Format</label>' +
                            '<select is="emby-select" onchange="updateDataAttribute(' + settingIndex + ', ' + attributeIndex + ', \'Format\', this.value)">' +
                                formatOptions +
                            '</select>' +
                        '</div>' +
                        '<div class="inputContainer">' +
                            '<label class="emby-checkbox-label">' +
                                '<input type="checkbox" is="emby-checkbox" ' + (attribute.Required ? 'checked' : '') +
                                       ' onchange="updateDataAttribute(' + settingIndex + ', ' + attributeIndex + ', \'Required\', this.checked)" />' +
                                '<span>Required</span>' +
                            '</label>' +
                        '</div>' +
                        '<div class="inputContainer form-grid-full">' +
                            '<label class="inputLabel inputLabelUnfocused">Default Value</label>' +
                            '<input type="text" is="emby-input" value="' + escapeHtml(attribute.DefaultValue || '') + '"' +
                                   ' onchange="updateDataAttribute(' + settingIndex + ', ' + attributeIndex + ', \'DefaultValue\', this.value)" />' +
                        '</div>' +
                    '</div>' +
                    '<div class="item-controls">' +
                        '<button type="button" is="emby-button" class="emby-button small-button danger-button" onclick="removeDataAttribute(' + settingIndex + ', ' + attributeIndex + ')">Remove</button>' +
                    '</div>' +
                '</div>';
            }

            // Update functions
            function updateScriptSetting(index, property, value) {
                JellyPyConfig.currentConfig.ScriptSettings[index][property] = value;
            }

            function updateScriptExecution(index, property, value) {
                JellyPyConfig.currentConfig.ScriptSettings[index].Execution[property] = value;
            }

            function updateTriggers(index, eventType, checked) {
                var triggers = JellyPyConfig.currentConfig.ScriptSettings[index].Triggers;
                if (checked && !triggers.includes(eventType)) {
                    triggers.push(eventType);
                } else if (!checked && triggers.includes(eventType)) {
                    var idx = triggers.indexOf(eventType);
                    triggers.splice(idx, 1);
                }
                // Update the trigger count display
                renderScriptSettings();
            }

            function toggleScriptSetting(index) {
                var setting = JellyPyConfig.currentConfig.ScriptSettings[index];
                setting.Enabled = !setting.Enabled;
                renderScriptSettings();
            }

            // Condition management
            function addCondition(settingIndex) {
                var newCondition = {
                    Field: '',
                    Operator: 'Equals',
                    Value: '',
                    CaseSensitive: false
                };
                JellyPyConfig.currentConfig.ScriptSettings[settingIndex].Conditions.push(newCondition);
                renderScriptSettings();
            }

            function removeCondition(settingIndex, conditionIndex) {
                JellyPyConfig.currentConfig.ScriptSettings[settingIndex].Conditions.splice(conditionIndex, 1);
                renderScriptSettings();
            }

            function updateCondition(settingIndex, conditionIndex, property, value) {
                JellyPyConfig.currentConfig.ScriptSettings[settingIndex].Conditions[conditionIndex][property] = value;
            }

            // Data attribute management
            function addDataAttribute(settingIndex) {
                var newAttribute = {
                    Name: '',
                    SourceField: '',
                    Format: 'String',
                    Required: false,
                    DefaultValue: ''
                };
                JellyPyConfig.currentConfig.ScriptSettings[settingIndex].DataAttributes.push(newAttribute);
                renderScriptSettings();
            }

            function removeDataAttribute(settingIndex, attributeIndex) {
                JellyPyConfig.currentConfig.ScriptSettings[settingIndex].DataAttributes.splice(attributeIndex, 1);
                renderScriptSettings();
            }

            function updateDataAttribute(settingIndex, attributeIndex, property, value) {
                JellyPyConfig.currentConfig.ScriptSettings[settingIndex].DataAttributes[attributeIndex][property] = value;
            }

            // Utility functions
            function toggleExpandable(header) {
                var content = header.nextElementSibling;
                var arrow = header.querySelector('span:first-child');

                if (content.classList.contains('expanded')) {
                    content.classList.remove('expanded');
                    arrow.textContent = '▶';
                } else {
                    content.classList.add('expanded');
                    arrow.textContent = '▼';
                }
            }

            function escapeHtml(text) {
                if (text === null || text === undefined) return '';
                return text.toString().replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
            }

            function generateGuid() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    var r = Math.random() * 16 | 0,
                        v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }

            // API Key Loading Function
            async function loadApiKeys() {
                try {
                    const response = await ApiClient.ajax({
                        type: 'GET',
                        url: ApiClient.getUrl('/Plugins/Jellypy/api-keys')
                    });

                    let apiKeys = response;
                    if (response instanceof Response) {
                        if (response.ok) {
                            apiKeys = await response.json();
                        } else {
                            console.error('Failed to load API keys:', response.status);
                            return;
                        }
                    }

                    // Load decrypted API keys into the form fields
                    document.querySelector('#SonarrApiKey').value = apiKeys.SonarrApiKey || '';
                    document.querySelector('#RadarrApiKey').value = apiKeys.RadarrApiKey || '';
                } catch (error) {
                    console.error('Error loading API keys:', error);
                }
            }

            // Connection Test Function
            async function testConnection(type) {
                const isSonarr = type === 'sonarr';
                const buttonId = isSonarr ? 'testSonarrConnection' : 'testRadarrConnection';
                const textId = isSonarr ? 'testSonarrText' : 'testRadarrText';
                const resultId = isSonarr ? 'sonarrTestResult' : 'radarrTestResult';
                const urlId = isSonarr ? 'SonarrUrl' : 'RadarrUrl';
                const apiKeyId = isSonarr ? 'SonarrApiKey' : 'RadarrApiKey';
                const endpoint = isSonarr ? '/Plugins/Jellypy/test-sonarr' : '/Plugins/Jellypy/test-radarr';

                const button = document.getElementById(buttonId);
                const textElement = document.getElementById(textId);
                const resultElement = document.getElementById(resultId);
                const urlElement = document.getElementById(urlId);
                const apiKeyElement = document.getElementById(apiKeyId);

                const url = urlElement.value.trim();
                const apiKey = apiKeyElement.value.trim();

                if (!url || !apiKey) {
                    showTestResult(resultElement, false, 'Please enter both URL and API Key');
                    return;
                }

                // Disable button and show loading
                button.disabled = true;
                textElement.textContent = 'Testing...';
                resultElement.style.display = 'none';

                try {
                    const response = await ApiClient.ajax({
                        type: 'POST',
                        url: ApiClient.getUrl(endpoint),
                        data: JSON.stringify({ Url: url, ApiKey: apiKey }),
                        contentType: 'application/json'
                    });

                    let result = response;
                    if (response instanceof Response) {
                        result = await response.json();
                    }

                    showTestResult(resultElement, result.Success, result.Message);
                } catch (error) {
                    console.error(type + ' test error:', error);
                    showTestResult(resultElement, false, `Test failed: ${error.message || 'Unknown error'}`);
                } finally {
                    // Re-enable button
                    button.disabled = false;
                    textElement.textContent = 'Test ' + (isSonarr ? 'Sonarr' : 'Radarr') + ' Connection';
                }
            }

            // Connection Test Functions
            async function testSonarrConnection() {
                await testConnection('sonarr');
            }

            async function testRadarrConnection() {
                await testConnection('radarr');
            }

            function showTestResult(element, success, message) {
                element.style.display = 'block';
                element.textContent = message;
                element.style.color = success ? '#4CAF50' : '#f44336';
            }

            // Script Management Functions
            async function loadAvailableScripts() {
                try {
                    const response = await ApiClient.ajax({
                        type: 'GET',
                        url: ApiClient.getUrl('/Plugins/Jellypy/scripts')
                    });

                    console.log('Raw API Response:', response);
                    console.log('Response type:', typeof response);
                    console.log('Is Response object:', response instanceof Response);

                    // Parse JSON from Response object if needed
                    let data = response;
                    if (response instanceof Response) {
                        if (response.ok) {
                            data = await response.json();
                            console.log('Parsed JSON data:', data);
                        } else {
                            console.error('API request failed:', response.status, response.statusText);
                            return [];
                        }
                    }

                    // Handle different response formats
                    let scripts = data;

                    // If response is wrapped in an object, try to extract the array
                    if (data && typeof data === 'object' && !Array.isArray(data)) {
                        // Check common wrapper properties
                        if (Array.isArray(data.Items)) {
                            scripts = data.Items;
                        } else if (Array.isArray(data.items)) {
                            scripts = data.items;
                        } else if (Array.isArray(data.data)) {
                            scripts = data.data;
                        } else if (Array.isArray(data.scripts)) {
                            scripts = data.scripts;
                        }
                    }

                    // Ensure we have an array
                    if (!Array.isArray(scripts)) {
                        console.warn('Expected array but got:', scripts);
                        return [];
                    }

                    console.log('Final processed scripts:', scripts);
                    return scripts;
                } catch (error) {
                    console.error('Failed to load scripts:', error);
                    return [];
                }
            }

            async function populateScriptDropdown(selectElement, currentValue) {
                const scripts = await loadAvailableScripts();

                console.log('Populating dropdown with scripts:', scripts);

                // Ensure scripts is an array
                if (!Array.isArray(scripts)) {
                    console.error('Scripts is not an array:', scripts);
                    return;
                }

                // Clear existing options except the first one
                while (selectElement.children.length > 1) {
                    selectElement.removeChild(selectElement.lastChild);
                }

                // Add script options
                scripts.forEach(function(script) {
                    console.log('Processing script:', script);
                    const option = document.createElement('option');
                    option.value = script.Path;
                    option.textContent = script.Name + ' (' + script.RelativePath + ')';
                    if (script.Path === currentValue) {
                        option.selected = true;
                    }
                    selectElement.appendChild(option);
                });

                // If current value doesn't match any script, add it as custom option
                if (currentValue && !scripts.some(s => s.Path === currentValue)) {
                    const customOption = document.createElement('option');
                    customOption.value = currentValue;
                    customOption.textContent = 'Custom: ' + currentValue;
                    customOption.selected = true;
                    selectElement.appendChild(customOption);
                }

                console.log('Dropdown populated with', scripts.length, 'scripts');
            }

            function refreshScripts(scriptIndex) {
                const selectElement = document.getElementById('scriptSelect-' + scriptIndex);
                const currentValue = selectElement.value;
                populateScriptDropdown(selectElement, currentValue);
            }

            function toggleCustomScriptPath(scriptIndex) {
                const selectElement = document.getElementById('scriptSelect-' + scriptIndex);
                const customInput = document.getElementById('customScriptPath-' + scriptIndex);

                if (customInput.style.display === 'none') {
                    // Show custom input
                    customInput.style.display = 'block';
                    customInput.value = selectElement.value;
                    customInput.focus();
                } else {
                    // Hide custom input and update select
                    customInput.style.display = 'none';
                    const customValue = customInput.value;
                    if (customValue) {
                        // Add custom value to dropdown if not exists
                        let optionExists = false;
                        for (let i = 0; i < selectElement.children.length; i++) {
                            if (selectElement.children[i].value === customValue) {
                                selectElement.children[i].selected = true;
                                optionExists = true;
                                break;
                            }
                        }
                        if (!optionExists) {
                            const customOption = document.createElement('option');
                            customOption.value = customValue;
                            customOption.textContent = 'Custom: ' + customValue;
                            customOption.selected = true;
                            selectElement.appendChild(customOption);
                        }
                    }
                }
            }

            // Page initialization
            document.querySelector('#JellyPyConfigPage')
                .addEventListener('pageshow', function() {
                    Dashboard.showLoadingMsg();
                    ApiClient.getPluginConfiguration(JellyPyConfig.pluginUniqueId).then(function (config) {
                        JellyPyConfig.currentConfig = config;

                        // Load global settings
                        var globalSettings = config.GlobalSettings || {};
                        document.querySelector('#MaxConcurrentExecutions').value = globalSettings.MaxConcurrentExecutions || 5;
                        document.querySelector('#DefaultTimeoutSeconds').value = globalSettings.DefaultTimeoutSeconds || 300;
                        document.querySelector('#QueueSize').value = globalSettings.QueueSize || 100;
                        document.querySelector('#EnableVerboseLogging').checked = globalSettings.EnableVerboseLogging || false;

                        // Load native integration settings
                        document.querySelector('#EnableNativeSonarrIntegration').checked = config.EnableNativeSonarrIntegration !== undefined ? config.EnableNativeSonarrIntegration : true;
                        document.querySelector('#SonarrUrl').value = config.SonarrUrl || '';
                        // API key will be loaded separately via API call
                        document.querySelector('#EpisodeDownloadBuffer').value = config.EpisodeDownloadBuffer || 5;
                        document.querySelector('#AutoSearchEpisodes').checked = config.AutoSearchEpisodes !== undefined ? config.AutoSearchEpisodes : true;
                        document.querySelector('#MonitorFutureEpisodes').checked = config.MonitorFutureEpisodes !== undefined ? config.MonitorFutureEpisodes : true;
                        document.querySelector('#SkipEpisodesWithFiles').checked = config.SkipEpisodesWithFiles !== undefined ? config.SkipEpisodesWithFiles : true;
                        document.querySelector('#UnmonitorWatchedEpisodes').checked = config.UnmonitorWatchedEpisodes !== undefined ? config.UnmonitorWatchedEpisodes : true;
                        document.querySelector('#MonitorOnlyCurrentSeason').checked = config.MonitorOnlyCurrentSeason !== undefined ? config.MonitorOnlyCurrentSeason : false;
                        document.querySelector('#MinimumEpisodeBuffer').value = config.MinimumEpisodeBuffer || 2;

                        document.querySelector('#EnableNativeRadarrIntegration').checked = config.EnableNativeRadarrIntegration !== undefined ? config.EnableNativeRadarrIntegration : true;
                        document.querySelector('#RadarrUrl').value = config.RadarrUrl || '';
                        // API key will be loaded separately via API call
                        document.querySelector('#UnmonitorWatchedMovies').checked = config.UnmonitorWatchedMovies !== undefined ? config.UnmonitorWatchedMovies : true;
                        document.querySelector('#UnmonitorOnlyIfWatched').checked = config.UnmonitorOnlyIfWatched !== undefined ? config.UnmonitorOnlyIfWatched : false;
                        document.querySelector('#MinimumWatchPercentage').value = config.MinimumWatchPercentage || 90;
                        document.querySelector('#UnmonitorAfterUpgrade').checked = config.UnmonitorAfterUpgrade !== undefined ? config.UnmonitorAfterUpgrade : false;

                        // Initialize script settings
                        if (!config.ScriptSettings) {
                            config.ScriptSettings = [];
                        }
                        renderScriptSettings();

                        // Load decrypted API keys separately
                        loadApiKeys();

                        // Add test connection button event listeners
                        document.getElementById('testSonarrConnection').addEventListener('click', testSonarrConnection);
                        document.getElementById('testRadarrConnection').addEventListener('click', testRadarrConnection);

                        Dashboard.hideLoadingMsg();
                    });
                });

            document.querySelector('#JellyPyConfigForm')
                .addEventListener('submit', function(e) {
                    Dashboard.showLoadingMsg();

                    var config = JellyPyConfig.currentConfig;

                    // Save global settings
                    if (!config.GlobalSettings) {
                        config.GlobalSettings = {};
                    }
                    config.GlobalSettings.MaxConcurrentExecutions = parseInt(document.querySelector('#MaxConcurrentExecutions').value || 5, 10);
                    config.GlobalSettings.DefaultTimeoutSeconds = parseInt(document.querySelector('#DefaultTimeoutSeconds').value || 300, 10);
                    config.GlobalSettings.QueueSize = parseInt(document.querySelector('#QueueSize').value || 100, 10);
                    config.GlobalSettings.EnableVerboseLogging = document.querySelector('#EnableVerboseLogging').checked;

                    // Save native integration settings
                    config.EnableNativeSonarrIntegration = document.querySelector('#EnableNativeSonarrIntegration').checked;
                    config.SonarrUrl = document.querySelector('#SonarrUrl').value;
                    config.SonarrApiKeyEncrypted = document.querySelector('#SonarrApiKey').value;
                    config.EpisodeDownloadBuffer = parseInt(document.querySelector('#EpisodeDownloadBuffer').value || 5, 10);
                    config.AutoSearchEpisodes = document.querySelector('#AutoSearchEpisodes').checked;
                    config.MonitorFutureEpisodes = document.querySelector('#MonitorFutureEpisodes').checked;
                    config.SkipEpisodesWithFiles = document.querySelector('#SkipEpisodesWithFiles').checked;
                    config.UnmonitorWatchedEpisodes = document.querySelector('#UnmonitorWatchedEpisodes').checked;
                    config.MonitorOnlyCurrentSeason = document.querySelector('#MonitorOnlyCurrentSeason').checked;
                    config.MinimumEpisodeBuffer = parseInt(document.querySelector('#MinimumEpisodeBuffer').value || 2, 10);

                    config.EnableNativeRadarrIntegration = document.querySelector('#EnableNativeRadarrIntegration').checked;
                    config.RadarrUrl = document.querySelector('#RadarrUrl').value;
                    config.RadarrApiKeyEncrypted = document.querySelector('#RadarrApiKey').value;
                    config.UnmonitorWatchedMovies = document.querySelector('#UnmonitorWatchedMovies').checked;
                    config.UnmonitorOnlyIfWatched = document.querySelector('#UnmonitorOnlyIfWatched').checked;
                    config.MinimumWatchPercentage = parseInt(document.querySelector('#MinimumWatchPercentage').value || 90, 10);
                    config.UnmonitorAfterUpgrade = document.querySelector('#UnmonitorAfterUpgrade').checked;

                    ApiClient.updatePluginConfiguration(JellyPyConfig.pluginUniqueId, config).then(function (result) {
                        Dashboard.processPluginConfigurationUpdateResult(result);
                    });

                    e.preventDefault();
                    return false;
                });
        </script>
    </div>
</body>
</html>
