<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JellyPy</title>
    <style>
        /* Essential layout styles */
        .section-title {
            font-size: 1.2em;
            font-weight: bold;
        }
        
        .tab-container {
            margin-bottom: 20px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Script Settings Container */
        .script-settings-container {
            display: flex;
            gap: 20px;
            min-height: 500px;
        }
        
        .script-list {
            flex: 0 0 300px;
            border: 1px solid #444;
            border-radius: 4px;
            background: rgba(0, 0, 0, 0.2);
        }
        
        .script-list-header {
            padding: 15px;
            border-bottom: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .script-list-title {
            font-weight: bold;
            font-size: 1.3em;
        }
        
        .script-items {
            max-height: 450px;
            overflow-y: auto;
        }
        
        .script-details {
            flex: 1;
            border: 1px solid #444;
            border-radius: 4px;
            background: rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        .script-details-content {
            padding: 20px;
            max-height: 450px;
            overflow-y: auto;
        }
        
        /* Form layout helpers */
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-col {
            flex: 1;
        }
        
        .form-col-narrow {
            flex: 0 0 120px;
        }
        
        .empty-state {
            text-align: center;
            color: #888;
            font-style: italic;
            padding: 40px 20px;
        }
    </style>
</head>
<body>
    <div id="JellyPyConfigPage" data-role="page" class="page type-interior pluginConfigurationPage" data-require="emby-input,emby-button,emby-select,emby-checkbox">
        <div data-role="content">
            <div class="content-primary">
                <form id="JellyPyConfigForm">

                    <!-- Tab Navigation -->
                    <div class="tab-container">
                        <div class="tab-buttons" style="display: flex; border-bottom: 1px solid #555; margin-bottom: 20px;">
                            <button type="button" class="tab-button active" onclick="switchTab('advanced')" style="padding: 12px 24px; background: none; border: none; border-bottom: 3px solid #00a4dc; color: #fff; cursor: pointer; font-size: 15px; font-weight: 600;">Script Settings</button>
                            <button type="button" class="tab-button" onclick="switchTab('native')" style="padding: 12px 24px; background: none; border: none; border-bottom: 3px solid transparent; color: #ccc; cursor: pointer; font-size: 15px; font-weight: 600;">Native Integration</button>
                            <button type="button" class="tab-button" onclick="switchTab('global')" style="padding: 12px 24px; background: none; border: none; border-bottom: 3px solid transparent; color: #ccc; cursor: pointer; font-size: 15px; font-weight: 600;">Global Settings</button>
                        </div>
                    </div>

                    <!-- Script Settings Tab -->
                    <div id="advanced-tab" class="tab-content active" style="display: block;">
                        <div class="section-header">
                            <div class="section-title">Script Settings</div>
                        </div>
                        <div class="fieldDescription" style="margin-bottom: 20px;">
                            Configure custom scripts to run in response to Jellyfin events. Scripts can be triggered by playback events, library changes, user actions, and more.
                        </div>
                        
                        <div class="script-settings-container">
                            <!-- Script List -->
                            <div class="script-list">
                                <div class="script-list-header">
                                    <div class="script-list-title">Scripts</div>
                                    <button type="button" class="add-script-btn" onclick="addNewScript()" style="background: #00a4dc; color: white; border: none; padding: 8px 16px; border-radius: 3px; cursor: pointer; font-size: 14px; font-weight: 600; min-height: 36px;">+ Add</button>
                                </div>
                                <div class="script-items" id="scriptItems">
                                    <div class="empty-state" id="emptyState">
                                        No scripts configured yet.<br>
                                        Click "Add" to create your first script.
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Script Details -->
                            <div class="script-details">
                                <div class="script-details-content" id="scriptDetailsContent">
                                    <div class="no-script-selected" id="noScriptSelected" style="display: none;">
                                    </div>
                                    
                                    <!-- Script Form (hidden by default) -->
                                    <div id="scriptForm" style="display: none;">
                                        
                                        
                                        <!-- Basic Information -->
                                        <details open style="border: 1px solid #444; border-radius: 4px; margin-bottom: 20px;">
                                            <summary style="padding: 15px 18px; background: rgba(255, 255, 255, 0.05); cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #555; list-style: none; user-select: none; font-weight: bold; font-size: 16px;">
                                                Basic Information
                                            </summary>
                                            <div style="padding: 15px;">
                                                <div class="form-row">
                                                    <div class="form-col">
                                                        <label class="inputLabel inputLabelUnfocused" for="script-name">Script Name</label>
                                                        <input id="script-name" type="text" is="emby-input" />
                                                    </div>
                                                    <div class="form-col-narrow">
                                                        <label class="inputLabel inputLabelUnfocused" for="script-priority">Priority</label>
                                                        <input id="script-priority" type="number" is="emby-input" min="1" max="1000" />
                                                    </div>
                                                </div>
                                                <div class="inputContainer">
                                                    <label class="inputLabel inputLabelUnfocused" for="script-description">Description</label>
                                                    <input id="script-description" type="text" is="emby-input" />
                                                </div>
                                                <div class="checkboxContainer">
                                                    <label class="emby-checkbox-label">
                                                        <input id="script-enabled" type="checkbox" is="emby-checkbox" />
                                                        <span>Enable this script</span>
                                                    </label>
                                                </div>
                                            </div>
                                        </details>

                                        <!-- Execution Settings -->
                                        <details style="border: 1px solid #444; border-radius: 4px; margin-bottom: 20px;">
                                            <summary style="padding: 15px 18px; background: rgba(255, 255, 255, 0.05); cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #555; list-style: none; user-select: none; font-weight: bold; font-size: 16px;">
                                                Execution Settings
                                            </summary>
                                            <div style="padding: 15px;" id="executionSettingsContent"></div>
                                        </details>

                                        <!-- Event Triggers -->
                                        <details style="border: 1px solid #444; border-radius: 4px; margin-bottom: 20px;">
                                            <summary style="padding: 15px 18px; background: rgba(255, 255, 255, 0.05); cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #555; list-style: none; user-select: none; font-weight: bold; font-size: 16px;">
                                                Event Triggers
                                            </summary>
                                            <div style="padding: 15px;">
                                                <div class="fieldDescription" style="margin-bottom: 15px;">
                                                    Select which Jellyfin events should trigger this script.
                                                </div>
                                                <div class="trigger-checkboxes" id="triggerCheckboxes"></div>
                                            </div>
                                        </details>

                                        <!-- Execution Conditions -->
                                        <details style="border: 1px solid #444; border-radius: 4px; margin-bottom: 20px;">
                                            <summary style="padding: 15px 18px; background: rgba(255, 255, 255, 0.05); cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #555; list-style: none; user-select: none; font-weight: bold; font-size: 16px;">
                                                Execution Conditions
                                            </summary>
                                            <div style="padding: 15px;">
                                                <div class="fieldDescription" style="margin-bottom: 15px;">
                                                    Add conditions to control when this script should run. All conditions must be met for the script to execute.
                                                </div>
                                                <div id="conditionsContainer"></div>
                                                <button type="button" class="add-item-btn" onclick="addCondition()" style="background: #00a4dc; color: white; border: none; padding: 8px 16px; border-radius: 3px; cursor: pointer; font-size: 14px; font-weight: 600; min-height: 36px;">+ Add Condition</button>
                                            </div>
                                        </details>

                                        <!-- Data Attributes -->
                                        <details style="border: 1px solid #444; border-radius: 4px; margin-bottom: 20px;">
                                            <summary style="padding: 15px 18px; background: rgba(255, 255, 255, 0.05); cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #555; list-style: none; user-select: none; font-weight: bold; font-size: 16px;">
                                                Data Attributes
                                            </summary>
                                            <div style="padding: 15px;">
                                                <div class="fieldDescription" style="margin-bottom: 15px;">
                                                    Configure how event data is passed to your script. Data can be passed as JSON, environment variables, command line arguments, or plain strings.
                                                </div>
                                                <div id="dataAttributesContainer"></div>
                                                <button type="button" class="add-item-btn" onclick="addDataAttribute()" style="background: #00a4dc; color: white; border: none; padding: 8px 16px; border-radius: 3px; cursor: pointer; font-size: 14px; font-weight: 600; min-height: 36px;">+ Add Data Attribute</button>
                                            </div>
                                        </details>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Native Integration Tab -->
                    <div id="native-tab" class="tab-content" style="display: none;">
                        <div class="section-title" style="margin-bottom: 20px;">Sonarr & Radarr Integration</div>
                        <div class="fieldDescription" style="margin-bottom: 20px;">
                            Configure native integration with Sonarr and Radarr to automatically manage monitoring of TV shows and movies based on playback events.
                        </div>

                        <!-- Sonarr Settings -->
                        <details style="border: 1px solid #444; border-radius: 4px; margin-bottom: 20px;">
                            <summary style="padding: 15px 18px; background: rgba(255, 255, 255, 0.05); cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #555; list-style: none; user-select: none; font-weight: bold; font-size: 16px;">
                                Sonarr Configuration
                            </summary>
                            <div style="padding: 15px;">
                                <div class="checkboxContainer checkboxContainer-withDescription">
                                    <label class="emby-checkbox-label">
                                        <input id="EnableNativeSonarrIntegration" name="EnableNativeSonarrIntegration" type="checkbox" is="emby-checkbox" />
                                        <span>Enable Sonarr Integration</span>
                                    </label>
                                    <div class="fieldDescription">Enable automatic TV show monitoring management through Sonarr.</div>
                                </div>
                                <div class="inputContainer">
                                    <label class="inputLabel inputLabelUnfocused" for="SonarrUrl">Sonarr URL</label>
                                    <input id="SonarrUrl" name="SonarrUrl" type="text" is="emby-input" placeholder="http://localhost:8989" />
                                    <div class="fieldDescription">The URL of your Sonarr instance (e.g., http://localhost:8989).</div>
                                </div>
                                <div class="inputContainer">
                                    <label class="inputLabel inputLabelUnfocused" for="SonarrApiKey">Sonarr API Key</label>
                                    <input id="SonarrApiKey" name="SonarrApiKey" type="password" is="emby-input" />
                                    <div class="fieldDescription">Your Sonarr API key (found in Settings → General → Security).</div>
                                </div>
                                <div class="inputContainer">
                                    <button id="testSonarrConnection" type="button" is="emby-button" class="raised button-submit" style="margin-bottom: 10px; padding: 10px 20px; font-size: 14px; min-height: 40px;">
                                        <span id="testSonarrText">Test Sonarr Connection</span>
                                    </button>
                                    <div id="sonarrTestResult" class="fieldDescription" style="display: none; font-weight: bold;"></div>
                                </div>
                                <div class="inputContainer">
                                    <label class="inputLabel inputLabelUnfocused" for="EpisodeDownloadBuffer">Episode Buffer</label>
                                    <input id="EpisodeDownloadBuffer" name="EpisodeDownloadBuffer" type="number" is="emby-input" min="1" max="20" />
                                    <div class="fieldDescription">Number of episodes to monitor ahead of your current position. When you watch an episode, the plugin will monitor this many episodes forward from where you are (default: 6).</div>
                                </div>
                                <div class="checkboxContainer checkboxContainer-withDescription">
                                    <label class="emby-checkbox-label">
                                        <input id="AutoSearchEpisodes" name="AutoSearchEpisodes" type="checkbox" is="emby-checkbox" />
                                        <span>Auto-Search Episodes</span>
                                    </label>
                                    <div class="fieldDescription">Automatically trigger searches for newly monitored episodes in Sonarr.</div>
                                </div>
                                <div class="checkboxContainer checkboxContainer-withDescription">
                                    <label class="emby-checkbox-label">
                                        <input id="MonitorFutureEpisodes" name="MonitorFutureEpisodes" type="checkbox" is="emby-checkbox" />
                                        <span>Monitor Future Episodes</span>
                                    </label>
                                    <div class="fieldDescription">Automatically monitor future episodes when they are added to Sonarr.</div>
                                </div>
                                <div class="checkboxContainer checkboxContainer-withDescription">
                                    <label class="emby-checkbox-label">
                                        <input id="SkipEpisodesWithFiles" name="SkipEpisodesWithFiles" type="checkbox" is="emby-checkbox" />
                                        <span>Skip Episodes With Files</span>
                                    </label>
                                    <div class="fieldDescription">Only monitor episodes that don't have files yet. Disable to re-monitor all episodes (useful for quality upgrades).</div>
                                </div>
                                <div class="checkboxContainer checkboxContainer-withDescription">
                                    <label class="emby-checkbox-label">
                                        <input id="UnmonitorWatchedEpisodes" name="UnmonitorWatchedEpisodes" type="checkbox" is="emby-checkbox" />
                                        <span>Unmonitor Watched Episodes</span>
                                    </label>
                                    <div class="fieldDescription">Unmonitor episodes after they are watched. Disable to keep all episodes monitored.</div>
                                </div>
                                <div class="checkboxContainer checkboxContainer-withDescription">
                                    <label class="emby-checkbox-label">
                                        <input id="MonitorOnlyCurrentSeason" name="MonitorOnlyCurrentSeason" type="checkbox" is="emby-checkbox" />
                                        <span>Monitor Only Current Season</span>
                                    </label>
                                    <div class="fieldDescription">When enabled, only monitors episodes in the same season you're currently watching. Future seasons won't be monitored until you start watching them.</div>
                                </div>
                            </div>
                        </details>

                        <!-- Radarr Settings -->
                        <details style="border: 1px solid #444; border-radius: 4px; margin-bottom: 20px;">
                            <summary style="padding: 15px 18px; background: rgba(255, 255, 255, 0.05); cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #555; list-style: none; user-select: none; font-weight: bold; font-size: 16px;">
                                Radarr Configuration
                            </summary>
                            <div style="padding: 15px;">
                                <div class="checkboxContainer checkboxContainer-withDescription">
                                    <label class="emby-checkbox-label">
                                        <input id="EnableNativeRadarrIntegration" name="EnableNativeRadarrIntegration" type="checkbox" is="emby-checkbox" />
                                        <span>Enable Radarr Integration</span>
                                    </label>
                                    <div class="fieldDescription">Enable automatic movie monitoring management through Radarr.</div>
                                </div>
                                <div class="inputContainer">
                                    <label class="inputLabel inputLabelUnfocused" for="RadarrUrl">Radarr URL</label>
                                    <input id="RadarrUrl" name="RadarrUrl" type="text" is="emby-input" placeholder="http://localhost:7878" />
                                    <div class="fieldDescription">The URL of your Radarr instance (e.g., http://localhost:7878).</div>
                                </div>
                                <div class="inputContainer">
                                    <label class="inputLabel inputLabelUnfocused" for="RadarrApiKey">Radarr API Key</label>
                                    <input id="RadarrApiKey" name="RadarrApiKey" type="password" is="emby-input" />
                                    <div class="fieldDescription">Your Radarr API key (found in Settings → General → Security).</div>
                                </div>
                                <div class="inputContainer">
                                    <button id="testRadarrConnection" type="button" is="emby-button" class="raised button-submit" style="margin-bottom: 10px; padding: 10px 20px; font-size: 14px; min-height: 40px;">
                                        <span id="testRadarrText">Test Radarr Connection</span>
                                    </button>
                                    <div id="radarrTestResult" class="fieldDescription" style="display: none; font-weight: bold;"></div>
                                </div>
                                <div class="checkboxContainer checkboxContainer-withDescription">
                                    <label class="emby-checkbox-label">
                                        <input id="UnmonitorWatchedMovies" name="UnmonitorWatchedMovies" type="checkbox" is="emby-checkbox" />
                                        <span>Unmonitor Watched Movies</span>
                                    </label>
                                    <div class="fieldDescription">Automatically set movies to unmonitored in Radarr after they are watched.</div>
                                </div>
                                <div class="checkboxContainer checkboxContainer-withDescription">
                                    <label class="emby-checkbox-label">
                                        <input id="UnmonitorOnlyIfWatched" name="UnmonitorOnlyIfWatched" type="checkbox" is="emby-checkbox" />
                                        <span>Unmonitor Only If Actually Watched</span>
                                    </label>
                                    <div class="fieldDescription">Only unmonitor movies if the user watched at least the configured percentage. Requires PlaybackStop event.</div>
                                </div>
                                <div class="inputContainer">
                                    <label class="inputLabel inputLabelUnfocused" for="MinimumWatchPercentage">Minimum Watch Percentage</label>
                                    <input id="MinimumWatchPercentage" name="MinimumWatchPercentage" type="number" is="emby-input" min="0" max="100" />
                                    <div class="fieldDescription">Minimum percentage of the movie that must be watched to consider it "watched" (default: 90).</div>
                                </div>
                                <div class="checkboxContainer checkboxContainer-withDescription">
                                    <label class="emby-checkbox-label">
                                        <input id="UnmonitorAfterUpgrade" name="UnmonitorAfterUpgrade" type="checkbox" is="emby-checkbox" />
                                        <span>Unmonitor After Quality Cutoff</span>
                                    </label>
                                    <div class="fieldDescription">Only unmonitor movies that have reached their quality cutoff (no upgrade possible).</div>
                                </div>
                            </div>
                        </details>
                    </div>

                    <!-- Global Settings Tab -->
                    <div id="global-tab" class="tab-content" style="display: none;">
                        <div class="section-title" style="margin-bottom: 20px;">Global Execution Settings</div>
                        
                        <details open style="border: 1px solid #444; border-radius: 4px; margin-bottom: 20px;">
                            <summary style="padding: 15px 18px; background: rgba(255, 255, 255, 0.05); cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #555; list-style: none; user-select: none; font-weight: bold; font-size: 16px;">
                                Interpreter Paths
                            </summary>
                            <div style="padding: 15px;">
                                <div class="inputContainer">
                                    <label class="inputLabel inputLabelUnfocused" for="PythonExecutablePath">Python Executable Path</label>
                                    <input id="PythonExecutablePath" name="PythonExecutablePath" type="text" is="emby-input" placeholder="/usr/bin/python3" />
                                    <div class="fieldDescription">Path to the Python interpreter executable. Example: /usr/bin/python3</div>
                                </div>
                                <div class="inputContainer" style="margin-top: 15px;">
                                    <button id="testPythonExecutable" type="button" is="emby-button" class="raised button-submit" style="margin-bottom: 10px; padding: 10px 20px; font-size: 14px; min-height: 40px;">
                                        <span id="testPythonExecText">Test Python Path</span>
                                    </button>
                                    <div id="pythonExecTestResult" class="fieldDescription" style="display: none; font-weight: bold;"></div>
                                </div>
                                <div class="inputContainer" style="margin-top: 20px;">
                                    <label class="inputLabel inputLabelUnfocused" for="BashExecutablePath">Bash Executable Path</label>
                                    <input id="BashExecutablePath" name="BashExecutablePath" type="text" is="emby-input" placeholder="/bin/bash" />
                                    <div class="fieldDescription">Path to the Bash interpreter executable. Example: /bin/bash</div>
                                </div>
                                <div class="inputContainer" style="margin-top: 15px;">
                                    <button id="testBashExecutable" type="button" is="emby-button" class="raised button-submit" style="margin-bottom: 10px; padding: 10px 20px; font-size: 14px; min-height: 40px;">
                                        <span id="testBashExecText">Test Bash Path</span>
                                    </button>
                                    <div id="bashExecTestResult" class="fieldDescription" style="display: none; font-weight: bold;"></div>
                                </div>
                            </div>
                        </details>
                        
                        <details open style="border: 1px solid #444; border-radius: 4px; margin-bottom: 20px;">
                            <summary style="padding: 15px 18px; background: rgba(255, 255, 255, 0.05); cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #555; list-style: none; user-select: none; font-weight: bold; font-size: 16px;">
                                Script Directory
                            </summary>
                            <div style="padding: 15px;">
                                <div class="inputContainer">
                                    <label class="inputLabel inputLabelUnfocused" for="CustomScriptsDirectory">Scripts Directory Path</label>
                                    <input id="CustomScriptsDirectory" name="CustomScriptsDirectory" type="text" is="emby-input" placeholder="/path/to/scripts" />
                                    <div class="fieldDescription">The directory to scan for .py and .sh script files. Leave empty to use the default plugin scripts directory.</div>
                                </div>
                                <div class="inputContainer" style="margin-top: 15px;">
                                    <button id="testScriptsDirectory" type="button" is="emby-button" class="raised button-submit" style="margin-bottom: 10px; padding: 10px 20px; font-size: 14px; min-height: 40px;">
                                        <span id="testScriptsDirText">Test Scripts Directory</span>
                                    </button>
                                    <div id="scriptsDirTestResult" class="fieldDescription" style="display: none; font-weight: bold;"></div>
                                </div>
                            </div>
                        </details>
                        
                        <details open style="border: 1px solid #444; border-radius: 4px; margin-bottom: 20px;">
                            <summary style="padding: 15px 18px; background: rgba(255, 255, 255, 0.05); cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #555; list-style: none; user-select: none; font-weight: bold; font-size: 16px;">
                                Execution Limits
                            </summary>
                            <div style="padding: 15px;">
                                <div class="inputContainer">
                                    <label class="inputLabel inputLabelUnfocused" for="MaxConcurrentExecutions">Max concurrent executions</label>
                                    <input id="MaxConcurrentExecutions" name="MaxConcurrentExecutions" type="number" is="emby-input" min="1" max="20" />
                                    <div class="fieldDescription">Maximum number of scripts that can run simultaneously.</div>
                                </div>
                                <div class="inputContainer">
                                    <label class="inputLabel inputLabelUnfocused" for="DefaultTimeoutSeconds">Default timeout (seconds)</label>
                                    <input id="DefaultTimeoutSeconds" name="DefaultTimeoutSeconds" type="number" is="emby-input" min="30" />
                                    <div class="fieldDescription">Default timeout for script execution when not specified in individual settings.</div>
                                </div>
                                <div class="inputContainer">
                                    <label class="inputLabel inputLabelUnfocused" for="QueueSize">Queue size</label>
                                    <input id="QueueSize" name="QueueSize" type="number" is="emby-input" min="10" />
                                    <div class="fieldDescription">Maximum number of pending script executions to queue.</div>
                                </div>
                            </div>
                        </details>
                        
                        <details open style="border: 1px solid #444; border-radius: 4px; margin-bottom: 20px;">
                            <summary style="padding: 15px 18px; background: rgba(255, 255, 255, 0.05); cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #555; list-style: none; user-select: none; font-weight: bold; font-size: 16px;">
                                Item Grouping
                            </summary>
                            <div style="padding: 15px;">
                                <div class="checkboxContainer checkboxContainer-withDescription">
                                    <label class="emby-checkbox-label">
                                        <input id="EnableItemGrouping" name="EnableItemGrouping" type="checkbox" is="emby-checkbox" />
                                        <span>Enable Item Grouping</span>
                                    </label>
                                    <div class="fieldDescription">Group items added in quick succession (e.g., a full season) into a single event to avoid spam.</div>
                                </div>
                                <div class="inputContainer">
                                    <label class="inputLabel inputLabelUnfocused" for="ItemGroupingDelaySeconds">Grouping Delay (seconds)</label>
                                    <input id="ItemGroupingDelaySeconds" name="ItemGroupingDelaySeconds" type="number" is="emby-input" min="1" max="60" />
                                    <div class="fieldDescription">Time to wait for more items before processing a group (default: 2 seconds).</div>
                                </div>
                            </div>
                        </details>

                        <details open style="border: 1px solid #444; border-radius: 4px; margin-bottom: 20px;">
                            <summary style="padding: 15px 18px; background: rgba(255, 255, 255, 0.05); cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #555; list-style: none; user-select: none; font-weight: bold; font-size: 16px;">
                                Logging
                            </summary>
                            <div style="padding: 15px;">
                                <div class="checkboxContainer checkboxContainer-withDescription">
                                    <label class="emby-checkbox-label">
                                        <input id="EnableVerboseLogging" name="EnableVerboseLogging" type="checkbox" is="emby-checkbox" />
                                        <span>Enable verbose logging</span>
                                    </label>
                                    <div class="fieldDescription">Log detailed information about script execution for debugging.</div>
                                </div>
                            </div>
                        </details>
                    </div>

                    <div style="margin-top: 30px;">
                        <button is="emby-button" type="submit" class="raised button-submit block emby-button" style="padding: 12px 24px; font-size: 16px; min-height: 44px;">
                            <span>Save</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <script type="text/javascript">
            var JellyPyConfig = {
                pluginUniqueId: 'a5bd541f-38dc-467e-9a9a-15fe3f3bcf5c',
                currentConfig: null,
                selectedScriptId: null,
                scriptSettings: []
            };

            // Script Management Functions
            function addNewScript() {
                var newScript = {
                    Id: generateGuid(),
                    Name: 'New Script',
                    Description: '',
                    Enabled: true,
                    Triggers: [],
                    Conditions: [],
                    Execution: {
                        ExecutorType: 0, // Python
                        ScriptPath: '',
                        WorkingDirectory: '',
                        AdditionalArguments: '',
                        TimeoutSeconds: 300
                    },
                    DataAttributes: [],
                    Priority: 100,
                    ExecutionMode: 0 // JsonPayload
                };
                
                JellyPyConfig.scriptSettings.push(newScript);
                renderScriptList();
                // Don't auto-select the new script - let user click it
                // This prevents form state issues and jumbling
            }

            function deleteScript(scriptId) {
                if (confirm('Are you sure you want to delete this script?')) {
                    JellyPyConfig.scriptSettings = JellyPyConfig.scriptSettings.filter(s => s.Id !== scriptId);
                    
                    if (JellyPyConfig.selectedScriptId === scriptId) {
                        JellyPyConfig.selectedScriptId = null;
                        renderScriptDetails();
                    }
                    
                    renderScriptList();
                }
            }

            function selectScript(scriptId) {
                // Toggle selection if clicking the same script
                if (JellyPyConfig.selectedScriptId === scriptId) {
                    JellyPyConfig.selectedScriptId = null;
                } else {
                    JellyPyConfig.selectedScriptId = scriptId;
                }
                
                // Update active state in list
                document.querySelectorAll('.script-item').forEach(function(item) {
                    item.classList.remove('active');
                });
                
                if (JellyPyConfig.selectedScriptId) {
                    var selectedItem = document.querySelector('[data-script-id="' + JellyPyConfig.selectedScriptId + '"]');
                    if (selectedItem) {
                        selectedItem.classList.add('active');
                    }
                }
                
                renderScriptDetails();
            }

            function renderScriptList() {
                var container = document.getElementById('scriptItems');
                var emptyState = document.getElementById('emptyState');
                
                if (JellyPyConfig.scriptSettings.length === 0) {
                    container.innerHTML = '';
                    if (!emptyState) {
                        emptyState = document.createElement('div');
                        emptyState.id = 'emptyState';
                        emptyState.className = 'empty-state';
                        emptyState.innerHTML = 'No scripts configured yet.<br>Click "Add" to create your first script.';
                        container.appendChild(emptyState);
                    }
                    emptyState.style.display = 'block';
                    return;
                }
                
                if (emptyState) {
                    emptyState.style.display = 'none';
                }
                
                // Remove only script-item elements, preserve emptyState
                var scriptItems = container.querySelectorAll('.script-item');
                scriptItems.forEach(function(item) {
                    item.remove();
                });
                
                JellyPyConfig.scriptSettings.forEach(function(script) {
                    var statusClass = script.Enabled ? 'status-enabled' : 'status-disabled';
                    var statusText = script.Enabled ? 'Enabled' : 'Disabled';
                    var isActive = script.Id === JellyPyConfig.selectedScriptId;
                    
                    var scriptItem = document.createElement('div');
                    scriptItem.className = 'script-item';
                    scriptItem.setAttribute('data-script-id', script.Id);
                    scriptItem.onclick = function() { selectScript(script.Id); };
                    
                    // Base styles for all scripts
                    var baseStyle = 'padding: 15px; margin: 10px 10px 25px 10px; border-radius: 4px; cursor: pointer; display: flex; justify-content: space-between; align-items: flex-start;';
                    
                    // Apply active or inactive styles
                    if (isActive) {
                        scriptItem.style.cssText = baseStyle + ' background: rgba(0, 164, 220, 0.3); border: 2px solid #00a4dc; box-shadow: 0 0 10px rgba(0, 164, 220, 0.3);';
                    } else {
                        scriptItem.style.cssText = baseStyle + ' background: rgba(0, 0, 0, 0.1); border: 1px solid #444;';
                    }
                    
                    var info = document.createElement('div');
                    info.style.cssText = 'flex: 1; padding-bottom: 5px;';
                    
                    var name = document.createElement('div');
                    name.style.cssText = 'font-weight: bold; font-size: 1.1em; margin-bottom: 8px; display: flex; align-items: center;';
                    
                    var arrow = document.createElement('span');
                    arrow.innerHTML = '&#9654;';
                    arrow.style.cssText = 'margin-right: 10px; font-size: 12px; display: inline-block; min-width: 12px; transition: transform 0.2s ease;';
                    
                    if (isActive) {
                        arrow.style.cssText += ' transform: rotate(90deg); color: #00a4dc;';
                    } else {
                        arrow.style.color = '#888';
                    }
                    
                    var nameText = document.createTextNode(script.Name);
                    
                    name.appendChild(arrow);
                    name.appendChild(nameText);
                    
                    var desc = document.createElement('div');
                    desc.textContent = script.Description || 'No description';
                    desc.style.cssText = 'font-size: 0.9em; color: #aaa; line-height: 1.4; margin-bottom: 15px;';
                    
                    info.appendChild(name);
                    info.appendChild(desc);
                    
                    var status = document.createElement('div');
                    status.style.cssText = 'margin-left: 10px;';
                    
                    var statusSpan = document.createElement('span');
                    statusSpan.textContent = statusText;
                    statusSpan.style.cssText = 'font-size: 0.8em;';
                    statusSpan.style.color = script.Enabled ? '#4CAF50' : '#888';
                    
                    var deleteBtn = document.createElement('button');
                    deleteBtn.type = 'button';
                    deleteBtn.textContent = '×';
                    deleteBtn.style.cssText = 'background: #d32f2f; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 0.8em; margin-left: 8px;';
                    deleteBtn.onclick = function(e) {
                        e.stopPropagation();
                        deleteScript(script.Id);
                    };
                    
                    status.appendChild(statusSpan);
                    status.appendChild(deleteBtn);
                    
                    scriptItem.appendChild(info);
                    scriptItem.appendChild(status);
                    
                    container.appendChild(scriptItem);
                });
            }

            function renderScriptDetails() {
                var noScriptDiv = document.getElementById('noScriptSelected');
                var formDiv = document.getElementById('scriptForm');
                
                if (!JellyPyConfig.selectedScriptId) {
                    noScriptDiv.style.display = 'none';
                    formDiv.style.display = 'none';
                    return;
                }
                
                var script = JellyPyConfig.scriptSettings.find(s => s.Id === JellyPyConfig.selectedScriptId);
                if (!script) {
                    return;
                }
                
                // Show form, hide "no script" message
                noScriptDiv.style.display = 'none';
                formDiv.style.display = 'block';
                
                // Populate basic fields
                document.getElementById('script-name').value = script.Name;
                document.getElementById('script-name').onchange = function() { updateScriptProperty('Name', this.value); };
                
                document.getElementById('script-priority').value = script.Priority;
                document.getElementById('script-priority').onchange = function() { updateScriptProperty('Priority', parseInt(this.value)); };
                
                document.getElementById('script-description').value = script.Description;
                document.getElementById('script-description').onchange = function() { updateScriptProperty('Description', this.value); };
                
                document.getElementById('script-enabled').checked = script.Enabled;
                document.getElementById('script-enabled').onchange = function() { updateScriptProperty('Enabled', this.checked); };
                
                document.getElementById('execution-mode').value = script.ExecutionMode;
                document.getElementById('execution-mode').onchange = function() { updateScriptProperty('ExecutionMode', parseInt(this.value)); };
                
                // Populate sections using existing render functions
                document.getElementById('triggerCheckboxes').innerHTML = renderTriggerCheckboxes(script.Triggers);
                document.getElementById('executionSettingsContent').innerHTML = renderExecutionSettings(script.Execution);
                document.getElementById('conditionsContainer').innerHTML = renderConditions(script.Conditions);
                document.getElementById('dataAttributesContainer').innerHTML = renderDataAttributes(script.DataAttributes);
                
                // Load available scripts into the dropdown after rendering
                loadAvailableScripts();
            }

            function updateScriptProperty(property, value) {
                var script = JellyPyConfig.scriptSettings.find(s => s.Id === JellyPyConfig.selectedScriptId);
                if (script) {
                    script[property] = value;
                    if (property === 'Name' || property === 'Enabled') {
                        renderScriptList();
                    }
                }
            }

            function renderTriggerCheckboxes(triggers) {
                var eventTypes = [
                    { value: 0, name: 'PlaybackStart', label: 'Playback Start' },
                    { value: 1, name: 'PlaybackStop', label: 'Playback Stop' },
                    { value: 2, name: 'PlaybackPause', label: 'Playback Pause' },
                    { value: 3, name: 'PlaybackResume', label: 'Playback Resume' },
                    { value: 4, name: 'ItemAdded', label: 'Item Added' },
                    { value: 5, name: 'ItemUpdated', label: 'Item Updated' },
                    { value: 6, name: 'ItemRemoved', label: 'Item Removed' },
                    { value: 7, name: 'UserCreated', label: 'User Created' },
                    { value: 8, name: 'UserUpdated', label: 'User Updated' },
                    { value: 9, name: 'UserDeleted', label: 'User Deleted' },
                    { value: 10, name: 'SessionStart', label: 'Session Start' },
                    { value: 11, name: 'SessionEnd', label: 'Session End' },
                    { value: 12, name: 'ServerStartup', label: 'Server Startup' },
                    { value: 13, name: 'ServerShutdown', label: 'Server Shutdown' }
                ];
                
                var html = '';
                eventTypes.forEach(function(eventType) {
                    var checked = triggers.includes(eventType.value) ? 'checked' : '';
                    html += '<div style="padding: 8px 12px; border: 1px solid #444; border-radius: 4px; margin-bottom: 8px; background: rgba(0, 0, 0, 0.1); display: flex; align-items: center;">' +
                            '<input type="checkbox" id="trigger-' + eventType.value + '" ' + checked + ' ' +
                                   'onchange="updateTrigger(' + eventType.value + ', this.checked)" style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer;" />' +
                            '<label for="trigger-' + eventType.value + '" style="cursor: pointer; flex: 1; margin: 0; font-size: 14px;">' + eventType.label + '</label>' +
                        '</div>';
                });
                return html;
            }

            function updateTrigger(eventType, checked) {
                var script = JellyPyConfig.scriptSettings.find(s => s.Id === JellyPyConfig.selectedScriptId);
                if (!script) return;
                
                if (checked) {
                    if (!script.Triggers.includes(eventType)) {
                        script.Triggers.push(eventType);
                    }
                } else {
                    script.Triggers = script.Triggers.filter(t => t !== eventType);
                }
            }

            function renderExecutionSettings(execution) {
                var executorTypes = [
                    { value: 0, label: 'Python' },
                    { value: 2, label: 'Bash' }
                ];
                
                var executorOptions = '';
                executorTypes.forEach(function(type) {
                    var selected = execution.ExecutorType === type.value ? 'selected' : '';
                    executorOptions += '<option value="' + type.value + '" ' + selected + '>' + type.label + '</option>';
                });
                
                var html = '<div class="form-row">' +
                        '<div class="form-col">' +
                            '<label class="inputLabel inputLabelUnfocused" for="executor-type">Executor</label>' +
                            '<select id="executor-type" is="emby-select" onchange="updateExecutionProperty(\'ExecutorType\', parseInt(this.value))">' +
                                executorOptions +
                            '</select>' +
                            '<div class="fieldDescription">Select Python or Bash. Executable paths are configured in Global Settings.</div>' +
                        '</div>' +
                        '<div class="form-col">' +
                            '<label class="inputLabel inputLabelUnfocused" for="timeout-seconds">Timeout (seconds)</label>' +
                            '<input id="timeout-seconds" type="number" is="emby-input" min="30" max="3600" ' +
                                   'value="' + execution.TimeoutSeconds + '" onchange="updateExecutionProperty(\'TimeoutSeconds\', parseInt(this.value))" />' +
                        '</div>' +
                    '</div>' +
                    '<div class="inputContainer">' +
                        '<label class="inputLabel inputLabelUnfocused" for="script-path">Script</label>' +
                        '<select id="script-path" is="emby-select" onchange="updateExecutionProperty(\'ScriptPath\', this.value)">' +
                            '<option value="">Select a script file...</option>' +
                        '</select>' +
                    '</div>' +
                    '<div class="inputContainer">' +
                        '<label class="inputLabel inputLabelUnfocused" for="working-directory">Working Directory</label>' +
                        '<input id="working-directory" type="text" is="emby-input" ' +
                               'value="' + escapeHtml(execution.WorkingDirectory) + '" onchange="updateExecutionProperty(\'WorkingDirectory\', this.value)" />' +
                        '<div class="fieldDescription">Directory to run the script from (optional)</div>' +
                    '</div>' +
                    '<div class="inputContainer">' +
                        '<label class="inputLabel inputLabelUnfocused" for="additional-arguments">Additional Arguments</label>' +
                        '<input id="additional-arguments" type="text" is="emby-input" ' +
                               'value="' + escapeHtml(execution.AdditionalArguments) + '" onchange="updateExecutionProperty(\'AdditionalArguments\', this.value)" />' +
                        '<div class="fieldDescription">Extra command line arguments (optional)</div>' +
                    '</div>' +
                    '<div class="inputContainer">' +
                        '<label class="inputLabel inputLabelUnfocused" for="execution-mode">Execution Mode</label>' +
                        '<select id="execution-mode" is="emby-select">' +
                            '<option value="0">JSON Payload</option>' +
                            '<option value="1">Compatibility</option>' +
                        '</select>' +
                        '<div class="fieldDescription">"JSON Payload" sends the full event data as the first argument. "Compatibility" only sends individual data attributes.</div>' +
                    '</div>';
                return html;
            }

            function updateExecutionProperty(property, value) {
                var script = JellyPyConfig.scriptSettings.find(s => s.Id === JellyPyConfig.selectedScriptId);
                if (script) {
                    script.Execution[property] = value;
                }
            }

            function renderConditions(conditions) {
                if (conditions.length === 0) {
                    return '<div style="color: #888; font-style: italic; text-align: center; padding: 20px;">No conditions configured. Script will run for all matching events.</div>';
                }
                
                var html = '';
                conditions.forEach(function(condition, index) {
                    html += '<div class="condition-item" style="border: 1px solid #444; border-radius: 4px; padding: 15px; margin-bottom: 15px; position: relative; background: rgba(0, 0, 0, 0.1);">';
                    html += '<button type="button" class="remove-item-btn" onclick="removeCondition(' + index + ')" style="position: absolute; top: 10px; right: 10px; background: #d32f2f; color: white; border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 20px; line-height: 1; font-weight: bold;">&times;</button>';
                    html += '<div class="form-row">';
                    html += '<div class="form-col">';
                    html += '<label class="inputLabel inputLabelUnfocused">Field</label>';
                    html += '<input type="text" is="emby-input" value="' + escapeHtml(condition.Field) + '" ';
                    html += 'onchange="updateCondition(' + index + ', \'Field\', this.value)" ';
                    html += 'placeholder="e.g., User.Name, Item.Type, etc." />';
                    html += '</div>';
                    html += '<div class="form-col-narrow">';
                    html += '<label class="inputLabel inputLabelUnfocused">Operator</label>';
                    html += '<select is="emby-select" onchange="updateCondition(' + index + ', \'Operator\', parseInt(this.value))">';
                    html += renderOperatorOptions(condition.Operator);
                    html += '</select>';
                    html += '</div>';
                    html += '<div class="form-col">';
                    html += '<label class="inputLabel inputLabelUnfocused">Value</label>';
                    html += '<input type="text" is="emby-input" value="' + escapeHtml(condition.Value) + '" ';
                    html += 'onchange="updateCondition(' + index + ', \'Value\', this.value)" />';
                    html += '</div>';
                    html += '</div>';
                    html += '<div class="checkboxContainer">';
                    html += '<label class="emby-checkbox-label">';
                    html += '<input type="checkbox" is="emby-checkbox" ' + (condition.CaseSensitive ? 'checked' : '') + ' ';
                    html += 'onchange="updateCondition(' + index + ', \'CaseSensitive\', this.checked)" />';
                    html += '<span>Case Sensitive</span>';
                    html += '</label>';
                    html += '</div>';
                    html += '</div>';
                });
                return html;
            }

            function renderOperatorOptions(selectedOperator) {
                var operators = [
                    { value: 0, label: 'Equals' },
                    { value: 1, label: 'Not Equals' },
                    { value: 2, label: 'Contains' },
                    { value: 3, label: 'Not Contains' },
                    { value: 4, label: 'Starts With' },
                    { value: 5, label: 'Ends With' },
                    { value: 6, label: 'Regex' },
                    { value: 7, label: 'Greater Than' },
                    { value: 8, label: 'Less Than' },
                    { value: 9, label: 'In List' },
                    { value: 10, label: 'Not In List' }
                ];
                
                var html = '';
                operators.forEach(function(op) {
                    var selected = selectedOperator === op.value ? 'selected' : '';
                    html += '<option value="' + op.value + '" ' + selected + '>' + op.label + '</option>';
                });
                return html;
            }

            function addCondition() {
                var script = JellyPyConfig.scriptSettings.find(s => s.Id === JellyPyConfig.selectedScriptId);
                if (script) {
                    script.Conditions.push({
                        Field: '',
                        Operator: 0, // Equals
                        Value: '',
                        CaseSensitive: false
                    });
                    renderScriptDetails();
                }
            }

            function removeCondition(index) {
                var script = JellyPyConfig.scriptSettings.find(s => s.Id === JellyPyConfig.selectedScriptId);
                if (script) {
                    script.Conditions.splice(index, 1);
                    renderScriptDetails();
                }
            }

            function updateCondition(index, property, value) {
                var script = JellyPyConfig.scriptSettings.find(s => s.Id === JellyPyConfig.selectedScriptId);
                if (script && script.Conditions[index]) {
                    script.Conditions[index][property] = value;
                }
            }

            function renderDataAttributes(dataAttributes) {
                if (dataAttributes.length === 0) {
                    return '<div style="color: #888; font-style: italic; text-align: center; padding: 20px;">No data attributes configured. Event data will be passed as JSON.</div>';
                }
                
                var html = '';
                dataAttributes.forEach(function(attr, index) {
                    html += '<div class="data-attribute-item" style="border: 1px solid #444; border-radius: 4px; padding: 15px; margin-bottom: 15px; position: relative; background: rgba(0, 0, 0, 0.1);">';
                    html += '<button type="button" class="remove-item-btn" onclick="removeDataAttribute(' + index + ')" style="position: absolute; top: 10px; right: 10px; background: #d32f2f; color: white; border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 20px; line-height: 1; font-weight: bold;">&times;</button>';
                    html += '<div class="form-row">';
                    html += '<div class="form-col">';
                    html += '<label class="inputLabel inputLabelUnfocused">Attribute Name</label>';
                    html += '<input type="text" is="emby-input" value="' + escapeHtml(attr.Name) + '" ';
                    html += 'onchange="updateDataAttribute(' + index + ', \'Name\', this.value)" ';
                    html += 'placeholder="Variable name in script" />';
                    html += '</div>';
                    html += '<div class="form-col">';
                    html += '<label class="inputLabel inputLabelUnfocused">Source Field</label>';
                    html += '<input type="text" is="emby-input" value="' + escapeHtml(attr.SourceField) + '" ';
                    html += 'onchange="updateDataAttribute(' + index + ', \'SourceField\', this.value)" ';
                    html += 'placeholder="e.g., User.Name, Item.Id" />';
                    html += '</div>';
                    html += '</div>';
                    html += '<div class="form-row">';
                    html += '<div class="form-col">';
                    html += '<label class="inputLabel inputLabelUnfocused">Format</label>';
                    html += '<select is="emby-select" onchange="updateDataAttribute(' + index + ', \'Format\', parseInt(this.value))">';
                    html += renderFormatOptions(attr.Format);
                    html += '</select>';
                    html += '</div>';
                    html += '<div class="form-col">';
                    html += '<label class="inputLabel inputLabelUnfocused">Default Value</label>';
                    html += '<input type="text" is="emby-input" value="' + escapeHtml(attr.DefaultValue) + '" ';
                    html += 'onchange="updateDataAttribute(' + index + ', \'DefaultValue\', this.value)" />';
                    html += '</div>';
                    html += '</div>';
                    html += '<div class="checkboxContainer">';
                    html += '<label class="emby-checkbox-label">';
                    html += '<input type="checkbox" is="emby-checkbox" ' + (attr.Required ? 'checked' : '') + ' ';
                    html += 'onchange="updateDataAttribute(' + index + ', \'Required\', this.checked)" />';
                    html += '<span>Required</span>';
                    html += '</label>';
                    html += '</div>';
                    html += '</div>';
                });
                return html;
            }

            function renderFormatOptions(selectedFormat) {
                var formats = [
                    { value: 0, label: 'String' },
                    { value: 1, label: 'JSON' },
                    { value: 2, label: 'Environment Variable' },
                    { value: 3, label: 'Command Argument' }
                ];
                
                var html = '';
                formats.forEach(function(format) {
                    var selected = selectedFormat === format.value ? 'selected' : '';
                    html += '<option value="' + format.value + '" ' + selected + '>' + format.label + '</option>';
                });
                return html;
            }

            function addDataAttribute() {
                var script = JellyPyConfig.scriptSettings.find(s => s.Id === JellyPyConfig.selectedScriptId);
                if (script) {
                    script.DataAttributes.push({
                        Name: '',
                        SourceField: '',
                        Format: 0, // String
                        Required: false,
                        DefaultValue: ''
                    });
                    renderScriptDetails();
                }
            }

            function removeDataAttribute(index) {
                var script = JellyPyConfig.scriptSettings.find(s => s.Id === JellyPyConfig.selectedScriptId);
                if (script) {
                    script.DataAttributes.splice(index, 1);
                    renderScriptDetails();
                }
            }

            function updateDataAttribute(index, property, value) {
                var script = JellyPyConfig.scriptSettings.find(s => s.Id === JellyPyConfig.selectedScriptId);
                if (script && script.DataAttributes[index]) {
                    script.DataAttributes[index][property] = value;
                }
            }

            // Tab Management
            function switchTab(tabName) {
                // Hide all tab contents
                document.querySelectorAll('.tab-content').forEach(function(content) {
                    content.style.display = 'none';
                });

                // Remove active class and reset styles from all tab buttons
                document.querySelectorAll('.tab-button').forEach(function(button) {
                    button.classList.remove('active');
                    button.style.borderBottom = '3px solid transparent';
                    button.style.color = '#ccc';
                });

                // Show the selected tab content
                var targetTab = document.getElementById(tabName + '-tab');
                if (targetTab) {
                    targetTab.style.display = 'block';
                }

                // Add active class and styles to the button that matches this tab
                var targetButton = document.querySelector(".tab-button[onclick*=\"'" + tabName + "'\"]");
                if (targetButton) {
                    targetButton.classList.add('active');
                    targetButton.style.borderBottom = '3px solid #00a4dc';
                    targetButton.style.color = '#fff';
                }
            }

            // Utility functions
            function escapeHtml(text) {
                if (text === null || text === undefined) return '';
                return text.toString().replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
            }

            function generateGuid() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    var r = Math.random() * 16 | 0,
                        v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }

            // API Key Loading Function
            async function loadApiKeys() {
                try {
                    const response = await ApiClient.ajax({
                        type: 'GET',
                        url: ApiClient.getUrl('/Plugins/Jellypy/api-keys')
                    });

                    let apiKeys = response;
                    if (response instanceof Response) {
                        if (response.ok) {
                            apiKeys = await response.json();
                        } else {
                            console.error('Failed to load API keys:', response.status);
                            return;
                        }
                    }

                    // Load decrypted API keys into the form fields
                    document.querySelector('#SonarrApiKey').value = apiKeys.SonarrApiKey || '';
                    document.querySelector('#RadarrApiKey').value = apiKeys.RadarrApiKey || '';
                } catch (error) {
                    console.error('Error loading API keys:', error);
                }
            }

            // Load Available Scripts Function
            async function loadAvailableScripts() {
                try {
                    const response = await ApiClient.ajax({
                        type: 'GET',
                        url: ApiClient.getUrl('/Plugins/Jellypy/scripts')
                    });

                    let scriptList = response;
                    if (response instanceof Response) {
                        if (response.ok) {
                            scriptList = await response.json();
                        } else {
                            console.error('Failed to load available scripts:', response.status);
                            return;
                        }
                    }

                    // Populate the script dropdown for all open script forms
                    var scriptPath = document.getElementById('script-path');
                    if (scriptPath) {
                        var currentValue = scriptPath.value;
                        scriptPath.innerHTML = '<option value="">Select a script file...</option>';
                        
                        if (scriptList && scriptList.length > 0) {
                            scriptList.forEach(function(scriptFile) {
                                var option = document.createElement('option');
                                // Handle both 'name' (camelCase) and 'Name' (PascalCase)
                                var fileName = scriptFile.name || scriptFile.Name || 'Unknown';
                                option.value = fileName;
                                option.textContent = fileName;
                                scriptPath.appendChild(option);
                            });
                        }
                        
                        if (currentValue) {
                            scriptPath.value = currentValue;
                        }
                    }
                } catch (error) {
                    console.error('Error loading available scripts:', error);
                }
            }

            // Test Scripts Directory Function
            async function testScriptsDirectory() {
                const button = document.getElementById('testScriptsDirectory');
                const textElement = document.getElementById('testScriptsDirText');
                const resultElement = document.getElementById('scriptsDirTestResult');
                const pathElement = document.getElementById('CustomScriptsDirectory');

                const path = pathElement.value.trim();

                // Disable button and show loading
                button.disabled = true;
                textElement.textContent = 'Testing...';
                resultElement.style.display = 'none';

                try {
                    const response = await ApiClient.ajax({
                        type: 'POST',
                        url: ApiClient.getUrl('/Plugins/Jellypy/test-scripts-directory'),
                        data: JSON.stringify({ Path: path }),
                        contentType: 'application/json'
                    });

                    let result = response;
                    if (response instanceof Response) {
                        if (response.ok) {
                            result = await response.json();
                        } else {
                            showTestResult(resultElement, false, 'HTTP ' + response.status);
                            return;
                        }
                    }

                    showTestResult(resultElement, result.Success, result.Message);
                } catch (error) {
                    console.error('Scripts directory test error:', error);
                    showTestResult(resultElement, false, `Test failed: ${error.message || 'Unknown error'}`);
                } finally {
                    // Re-enable button
                    button.disabled = false;
                    textElement.textContent = 'Test Scripts Directory';
                }
            }

            // Test Python Executable Path Function
            async function testPythonExecutable() {
                const button = document.getElementById('testPythonExecutable');
                const textElement = document.getElementById('testPythonExecText');
                const resultElement = document.getElementById('pythonExecTestResult');
                const execPathElement = document.getElementById('PythonExecutablePath');

                const execPath = execPathElement.value.trim();

                if (!execPath) {
                    showTestResult(resultElement, false, 'Please enter a Python executable path');
                    return;
                }

                // Disable button and show loading
                button.disabled = true;
                textElement.textContent = 'Testing...';
                resultElement.style.display = 'none';

                try {
                    const response = await ApiClient.ajax({
                        type: 'POST',
                        url: ApiClient.getUrl('/Plugins/Jellypy/test-executable'),
                        data: JSON.stringify({ ExecutablePath: execPath }),
                        contentType: 'application/json'
                    });

                    let result = response;
                    if (response instanceof Response) {
                        if (response.ok) {
                            result = await response.json();
                        } else {
                            showTestResult(resultElement, false, 'HTTP ' + response.status);
                            return;
                        }
                    }

                    showTestResult(resultElement, result.Success, result.Message);
                } catch (error) {
                    console.error('Python path test error:', error);
                    showTestResult(resultElement, false, `Test failed: ${error.message || 'Unknown error'}`);
                } finally {
                    // Re-enable button
                    button.disabled = false;
                    textElement.textContent = 'Test Python Path';
                }
            }

            // Test Bash Executable Path Function
            async function testBashExecutable() {
                const button = document.getElementById('testBashExecutable');
                const textElement = document.getElementById('testBashExecText');
                const resultElement = document.getElementById('bashExecTestResult');
                const execPathElement = document.getElementById('BashExecutablePath');

                const execPath = execPathElement.value.trim();

                if (!execPath) {
                    showTestResult(resultElement, false, 'Please enter a Bash executable path');
                    return;
                }

                // Disable button and show loading
                button.disabled = true;
                textElement.textContent = 'Testing...';
                resultElement.style.display = 'none';

                try {
                    const response = await ApiClient.ajax({
                        type: 'POST',
                        url: ApiClient.getUrl('/Plugins/Jellypy/test-executable'),
                        data: JSON.stringify({ ExecutablePath: execPath }),
                        contentType: 'application/json'
                    });

                    let result = response;
                    if (response instanceof Response) {
                        if (response.ok) {
                            result = await response.json();
                        } else {
                            showTestResult(resultElement, false, 'HTTP ' + response.status);
                            return;
                        }
                    }

                    showTestResult(resultElement, result.Success, result.Message);
                } catch (error) {
                    console.error('Bash path test error:', error);
                    showTestResult(resultElement, false, `Test failed: ${error.message || 'Unknown error'}`);
                } finally {
                    // Re-enable button
                    button.disabled = false;
                    textElement.textContent = 'Test Bash Path';
                }
            }

            // Connection Test Function
            async function testConnection(type) {
                const isSonarr = type === 'sonarr';
                const buttonId = isSonarr ? 'testSonarrConnection' : 'testRadarrConnection';
                const textId = isSonarr ? 'testSonarrText' : 'testRadarrText';
                const resultId = isSonarr ? 'sonarrTestResult' : 'radarrTestResult';
                const urlId = isSonarr ? 'SonarrUrl' : 'RadarrUrl';
                const apiKeyId = isSonarr ? 'SonarrApiKey' : 'RadarrApiKey';
                const endpoint = isSonarr ? '/Plugins/Jellypy/test-sonarr' : '/Plugins/Jellypy/test-radarr';

                const button = document.getElementById(buttonId);
                const textElement = document.getElementById(textId);
                const resultElement = document.getElementById(resultId);
                const urlElement = document.getElementById(urlId);
                const apiKeyElement = document.getElementById(apiKeyId);

                const url = urlElement.value.trim();
                const apiKey = apiKeyElement.value.trim();

                if (!url || !apiKey) {
                    showTestResult(resultElement, false, 'Please enter both URL and API Key');
                    return;
                }

                // Disable button and show loading
                button.disabled = true;
                textElement.textContent = 'Testing...';
                resultElement.style.display = 'none';

                try {
                    const response = await ApiClient.ajax({
                        type: 'POST',
                        url: ApiClient.getUrl(endpoint),
                        data: JSON.stringify({ Url: url, ApiKey: apiKey }),
                        contentType: 'application/json'
                    });

                    let result = response;
                    if (response instanceof Response) {
                        result = await response.json();
                    }

                    showTestResult(resultElement, result.Success, result.Message);
                } catch (error) {
                    console.error(type + ' test error:', error);
                    showTestResult(resultElement, false, `Test failed: ${error.message || 'Unknown error'}`);
                } finally {
                    // Re-enable button
                    button.disabled = false;
                    textElement.textContent = 'Test ' + (isSonarr ? 'Sonarr' : 'Radarr') + ' Connection';
                }
            }

            // Connection Test Functions
            async function testSonarrConnection() {
                await testConnection('sonarr');
            }

            async function testRadarrConnection() {
                await testConnection('radarr');
            }

            function showTestResult(element, success, message) {
                element.style.display = 'block';
                element.textContent = message;
                element.style.color = success ? '#4CAF50' : '#f44336';
            }

            // Page initialization
            document.querySelector('#JellyPyConfigPage')
                .addEventListener('pageshow', function() {
                    Dashboard.showLoadingMsg();
                    ApiClient.getPluginConfiguration(JellyPyConfig.pluginUniqueId).then(function (config) {
                        JellyPyConfig.currentConfig = config;

                        // Load global settings
                        var globalSettings = config.GlobalSettings || {};
                        document.querySelector('#CustomScriptsDirectory').value = globalSettings.CustomScriptsDirectory || '';
                        document.querySelector('#PythonExecutablePath').value = globalSettings.PythonExecutablePath || '/usr/bin/python3';
                        document.querySelector('#BashExecutablePath').value = globalSettings.BashExecutablePath || '/bin/bash';
                        document.querySelector('#MaxConcurrentExecutions').value = globalSettings.MaxConcurrentExecutions || 5;
                        document.querySelector('#DefaultTimeoutSeconds').value = globalSettings.DefaultTimeoutSeconds || 300;
                        document.querySelector('#QueueSize').value = globalSettings.QueueSize || 100;
                        document.querySelector('#EnableVerboseLogging').checked = globalSettings.EnableVerboseLogging || false;

                        // Load item grouping settings
                        document.querySelector('#EnableItemGrouping').checked = config.EnableItemGrouping !== undefined ? config.EnableItemGrouping : true;
                        document.querySelector('#ItemGroupingDelaySeconds').value = config.ItemGroupingDelaySeconds || 2;

                        // Load native integration settings
                        document.querySelector('#EnableNativeSonarrIntegration').checked = config.EnableNativeSonarrIntegration !== undefined ? config.EnableNativeSonarrIntegration : true;
                        document.querySelector('#SonarrUrl').value = config.SonarrUrl || '';
                        // API key will be loaded separately via API call
                        document.querySelector('#EpisodeDownloadBuffer').value = config.EpisodeDownloadBuffer || 6;
                        document.querySelector('#AutoSearchEpisodes').checked = config.AutoSearchEpisodes !== undefined ? config.AutoSearchEpisodes : true;
                        document.querySelector('#MonitorFutureEpisodes').checked = config.MonitorFutureEpisodes !== undefined ? config.MonitorFutureEpisodes : true;
                        document.querySelector('#SkipEpisodesWithFiles').checked = config.SkipEpisodesWithFiles !== undefined ? config.SkipEpisodesWithFiles : true;
                        document.querySelector('#UnmonitorWatchedEpisodes').checked = config.UnmonitorWatchedEpisodes !== undefined ? config.UnmonitorWatchedEpisodes : true;
                        document.querySelector('#MonitorOnlyCurrentSeason').checked = config.MonitorOnlyCurrentSeason !== undefined ? config.MonitorOnlyCurrentSeason : false;

                        document.querySelector('#EnableNativeRadarrIntegration').checked = config.EnableNativeRadarrIntegration !== undefined ? config.EnableNativeRadarrIntegration : true;
                        document.querySelector('#RadarrUrl').value = config.RadarrUrl || '';
                        // API key will be loaded separately via API call
                        document.querySelector('#UnmonitorWatchedMovies').checked = config.UnmonitorWatchedMovies !== undefined ? config.UnmonitorWatchedMovies : true;
                        document.querySelector('#UnmonitorOnlyIfWatched').checked = config.UnmonitorOnlyIfWatched !== undefined ? config.UnmonitorOnlyIfWatched : false;
                        document.querySelector('#MinimumWatchPercentage').value = config.MinimumWatchPercentage || 90;
                        document.querySelector('#UnmonitorAfterUpgrade').checked = config.UnmonitorAfterUpgrade !== undefined ? config.UnmonitorAfterUpgrade : false;

                        // Initialize script settings placeholder
                        JellyPyConfig.scriptSettings = config.ScriptSettings || [];
                        renderScriptList();

                        // Load decrypted API keys separately
                        loadApiKeys();

                        // Add test connection button event listeners
                        document.getElementById('testSonarrConnection').addEventListener('click', testSonarrConnection);
                        document.getElementById('testRadarrConnection').addEventListener('click', testRadarrConnection);

                        // Add test scripts directory button event listener
                        document.getElementById('testScriptsDirectory').addEventListener('click', testScriptsDirectory);

                        // Add test executable path button event listeners
                        document.getElementById('testPythonExecutable').addEventListener('click', testPythonExecutable);
                        document.getElementById('testBashExecutable').addEventListener('click', testBashExecutable);

                        Dashboard.hideLoadingMsg();
                    });
                });

            document.querySelector('#JellyPyConfigForm')
                .addEventListener('submit', function(e) {
                    Dashboard.showLoadingMsg();

                    var config = JellyPyConfig.currentConfig;

                    // Save global settings
                    if (!config.GlobalSettings) {
                        config.GlobalSettings = {};
                    }
                    config.GlobalSettings.CustomScriptsDirectory = document.querySelector('#CustomScriptsDirectory').value;
                    config.GlobalSettings.PythonExecutablePath = document.querySelector('#PythonExecutablePath').value;
                    config.GlobalSettings.BashExecutablePath = document.querySelector('#BashExecutablePath').value;
                    config.GlobalSettings.MaxConcurrentExecutions = parseInt(document.querySelector('#MaxConcurrentExecutions').value || 5, 10);
                    config.GlobalSettings.DefaultTimeoutSeconds = parseInt(document.querySelector('#DefaultTimeoutSeconds').value || 300, 10);
                    config.GlobalSettings.QueueSize = parseInt(document.querySelector('#QueueSize').value || 100, 10);
                    config.GlobalSettings.EnableVerboseLogging = document.querySelector('#EnableVerboseLogging').checked;

                    // Save item grouping settings
                    config.EnableItemGrouping = document.querySelector('#EnableItemGrouping').checked;
                    config.ItemGroupingDelaySeconds = parseInt(document.querySelector('#ItemGroupingDelaySeconds').value || 2, 10);

                    // Save native integration settings
                    config.EnableNativeSonarrIntegration = document.querySelector('#EnableNativeSonarrIntegration').checked;
                    config.SonarrUrl = document.querySelector('#SonarrUrl').value;
                    config.SonarrApiKeyEncrypted = document.querySelector('#SonarrApiKey').value;
                    config.EpisodeDownloadBuffer = parseInt(document.querySelector('#EpisodeDownloadBuffer').value || 6, 10);
                    config.AutoSearchEpisodes = document.querySelector('#AutoSearchEpisodes').checked;
                    config.MonitorFutureEpisodes = document.querySelector('#MonitorFutureEpisodes').checked;
                    config.SkipEpisodesWithFiles = document.querySelector('#SkipEpisodesWithFiles').checked;
                    config.UnmonitorWatchedEpisodes = document.querySelector('#UnmonitorWatchedEpisodes').checked;
                    config.MonitorOnlyCurrentSeason = document.querySelector('#MonitorOnlyCurrentSeason').checked;

                    config.EnableNativeRadarrIntegration = document.querySelector('#EnableNativeRadarrIntegration').checked;
                    config.RadarrUrl = document.querySelector('#RadarrUrl').value;
                    config.RadarrApiKeyEncrypted = document.querySelector('#RadarrApiKey').value;
                    config.UnmonitorWatchedMovies = document.querySelector('#UnmonitorWatchedMovies').checked;
                    config.UnmonitorOnlyIfWatched = document.querySelector('#UnmonitorOnlyIfWatched').checked;
                    config.MinimumWatchPercentage = parseInt(document.querySelector('#MinimumWatchPercentage').value || 90, 10);
                    config.UnmonitorAfterUpgrade = document.querySelector('#UnmonitorAfterUpgrade').checked;

                    // Save script settings
                    config.ScriptSettings = JellyPyConfig.scriptSettings;

                    ApiClient.updatePluginConfiguration(JellyPyConfig.pluginUniqueId, config).then(function (result) {
                        Dashboard.processPluginConfigurationUpdateResult(result);
                    });

                    e.preventDefault();
                    return false;
                });
        </script>
    </div>
</body>
</html>
