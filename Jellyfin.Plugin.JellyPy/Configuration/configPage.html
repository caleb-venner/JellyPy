<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JellyPy</title>
    <style>
        .advanced-section {
            margin-top: 30px;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.1);
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #555;
        }
        .section-title {
            font-size: 1.2em;
            font-weight: bold;
        }
        .tab-container {
            margin-bottom: 20px;
        }
        .tab-buttons {
            display: flex;
            border-bottom: 1px solid #555;
            margin-bottom: 20px;
        }
        .tab-button {
            padding: 10px 20px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            color: #ccc;
            cursor: pointer;
            font-size: 1em;
        }
        .tab-button.active {
            color: #fff;
            border-bottom-color: #00a4dc;
        }
        .tab-button:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        /* Script Settings Styles */
        .script-settings-container {
            display: flex;
            gap: 20px;
            min-height: 500px;
        }
        
        .script-list {
            flex: 0 0 300px;
            border: 1px solid #444;
            border-radius: 4px;
            background: rgba(0, 0, 0, 0.2);
        }
        
        .script-list-header {
            padding: 15px;
            border-bottom: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .script-list-title {
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .add-script-btn {
            background: #00a4dc;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .add-script-btn:hover {
            background: #0084b4;
        }
        
        .script-items {
            max-height: 450px;
            overflow-y: auto;
        }
        
        .script-item {
            padding: 12px 15px;
            border-bottom: 1px solid #333;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .script-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .script-item.active {
            background: rgba(0, 164, 220, 0.2);
            border-left: 3px solid #00a4dc;
        }
        
        .script-item-info {
            flex: 1;
        }
        
        .script-item-name {
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .script-item-desc {
            font-size: 0.85em;
            color: #aaa;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .script-item-status {
            margin-left: 10px;
        }
        
        .status-enabled {
            color: #4CAF50;
            font-size: 0.8em;
        }
        
        .status-disabled {
            color: #888;
            font-size: 0.8em;
        }
        
        .delete-script-btn {
            background: #d32f2f;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
            margin-left: 8px;
        }
        
        .delete-script-btn:hover {
            background: #b71c1c;
        }
        
        .script-details {
            flex: 1;
            border: 1px solid #444;
            border-radius: 4px;
            background: rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        .script-details-header {
            padding: 15px;
            border-bottom: 1px solid #444;
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .script-details-content {
            padding: 20px;
            max-height: 450px;
            overflow-y: auto;
        }
        
        .no-script-selected {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #888;
            font-style: italic;
        }
        
        .script-form-section {
            margin-bottom: 25px;
        }
        
        .section-title-small {
            font-size: 1em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #00a4dc;
            border-bottom: 1px solid #555;
            padding-bottom: 5px;
        }
        
        .collapsible-section {
            border: 1px solid #555;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .collapsible-header {
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.05);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #555;
        }
        
        .collapsible-header:hover {
            background: rgba(255, 255, 255, 0.08);
        }
        
        .collapsible-title {
            font-weight: bold;
        }
        
        .collapsible-toggle {
            transition: transform 0.2s ease;
        }
        
        .collapsible-toggle.expanded {
            transform: rotate(90deg);
        }
        
        .collapsible-content {
            padding: 15px;
            display: none;
        }
        
        .collapsible-content.expanded {
            display: block;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-col {
            flex: 1;
        }
        
        .form-col-narrow {
            flex: 0 0 120px;
        }
        
        .condition-item, .data-attribute-item, .env-var-item {
            border: 1px solid #555;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 10px;
            background: rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        .remove-item-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #d32f2f;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .remove-item-btn:hover {
            background: #b71c1c;
        }
        
        .add-item-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 10px;
        }
        
        .add-item-btn:hover {
            background: #45a049;
        }
        
        .trigger-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .trigger-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .empty-state {
            text-align: center;
            color: #888;
            font-style: italic;
            padding: 40px 20px;
        }
    </style>
</head>
<body>
    <div id="JellyPyConfigPage" data-role="page" class="page type-interior pluginConfigurationPage" data-require="emby-input,emby-button,emby-select,emby-checkbox">
        <div data-role="content">
            <div class="content-primary">
                <form id="JellyPyConfigForm">

                    <!-- Tab Navigation -->
                    <div class="tab-container">
                        <div class="tab-buttons">
                            <button type="button" class="tab-button active" onclick="switchTab('advanced')">Script Settings</button>
                            <button type="button" class="tab-button" onclick="switchTab('native')">Native Integration</button>
                            <button type="button" class="tab-button" onclick="switchTab('global')">Global Settings</button>
                        </div>
                    </div>

                    <!-- Script Settings Tab -->
                    <div id="advanced-tab" class="tab-content active" style="display: block;">
                        <div class="section-header">
                            <div class="section-title">Script Settings</div>
                        </div>
                        <div class="fieldDescription" style="margin-bottom: 20px;">
                            Configure custom scripts to run in response to Jellyfin events. Scripts can be triggered by playback events, library changes, user actions, and more.
                        </div>
                        
                        <div class="script-settings-container">
                            <!-- Script List -->
                            <div class="script-list">
                                <div class="script-list-header">
                                    <div class="script-list-title">Scripts</div>
                                    <button type="button" class="add-script-btn" onclick="addNewScript()">+ Add</button>
                                </div>
                                <div class="script-items" id="scriptItems">
                                    <div class="empty-state" id="emptyState">
                                        No scripts configured yet.<br>
                                        Click "Add" to create your first script.
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Script Details -->
                            <div class="script-details">
                                <div class="script-details-header" id="scriptDetailsHeader">
                                    Script Details
                                </div>
                                <div class="script-details-content" id="scriptDetailsContent">
                                    <div class="no-script-selected" id="noScriptSelected">
                                        Select a script from the list to configure its settings
                                    </div>
                                    
                                    <!-- Script Form (hidden by default) -->
                                    <div id="scriptForm" style="display: none;">
                                        <!-- Basic Information -->
                                        <div class="script-form-section">
                                            <div class="section-title-small">Basic Information</div>
                                            <div class="form-row">
                                                <div class="form-col">
                                                    <label class="inputLabel inputLabelUnfocused" for="script-name">Script Name</label>
                                                    <input id="script-name" type="text" is="emby-input" />
                                                </div>
                                                <div class="form-col-narrow">
                                                    <label class="inputLabel inputLabelUnfocused" for="script-priority">Priority</label>
                                                    <input id="script-priority" type="number" is="emby-input" min="1" max="1000" />
                                                </div>
                                            </div>
                                            <div class="inputContainer">
                                                <label class="inputLabel inputLabelUnfocused" for="script-description">Description</label>
                                                <input id="script-description" type="text" is="emby-input" />
                                            </div>
                                            <div class="checkboxContainer">
                                                <label class="emby-checkbox-label">
                                                    <input id="script-enabled" type="checkbox" is="emby-checkbox" />
                                                    <span>Enable this script</span>
                                                </label>
                                            </div>
                                        </div>

                                        <!-- Event Triggers -->
                                        <div class="collapsible-section">
                                            <div class="collapsible-header" onclick="toggleCollapsible(this)">
                                                <span class="collapsible-title">Event Triggers</span>
                                                <span class="collapsible-toggle">▶</span>
                                            </div>
                                            <div class="collapsible-content">
                                                <div class="fieldDescription" style="margin-bottom: 15px;">
                                                    Select which Jellyfin events should trigger this script.
                                                </div>
                                                <div class="trigger-checkboxes" id="triggerCheckboxes"></div>
                                            </div>
                                        </div>

                                        <!-- Execution Settings -->
                                        <div class="collapsible-section">
                                            <div class="collapsible-header" onclick="toggleCollapsible(this)">
                                                <span class="collapsible-title">Execution Settings</span>
                                                <span class="collapsible-toggle">▶</span>
                                            </div>
                                            <div class="collapsible-content" id="executionSettingsContent"></div>
                                        </div>

                                        <!-- Execution Conditions -->
                                        <div class="collapsible-section">
                                            <div class="collapsible-header" onclick="toggleCollapsible(this)">
                                                <span class="collapsible-title">Execution Conditions</span>
                                                <span class="collapsible-toggle">▶</span>
                                            </div>
                                            <div class="collapsible-content">
                                                <div class="fieldDescription" style="margin-bottom: 15px;">
                                                    Add conditions to control when this script should run. All conditions must be met for the script to execute.
                                                </div>
                                                <div id="conditionsContainer"></div>
                                                <button type="button" class="add-item-btn" onclick="addCondition()">+ Add Condition</button>
                                            </div>
                                        </div>

                                        <!-- Data Attributes -->
                                        <div class="collapsible-section">
                                            <div class="collapsible-header" onclick="toggleCollapsible(this)">
                                                <span class="collapsible-title">Data Attributes</span>
                                                <span class="collapsible-toggle">▶</span>
                                            </div>
                                            <div class="collapsible-content">
                                                <div class="fieldDescription" style="margin-bottom: 15px;">
                                                    Configure how event data is passed to your script. Data can be passed as JSON, environment variables, command line arguments, or plain strings.
                                                </div>
                                                <div id="dataAttributesContainer"></div>
                                                <button type="button" class="add-item-btn" onclick="addDataAttribute()">+ Add Data Attribute</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Native Integration Tab -->
                    <div id="native-tab" class="tab-content" style="display: none;">
                        <div class="section-title" style="margin-bottom: 20px;">Sonarr & Radarr Integration</div>
                        <div class="fieldDescription" style="margin-bottom: 20px;">
                            Configure native integration with Sonarr and Radarr to automatically manage monitoring of TV shows and movies based on playback events.
                        </div>

                        <!-- Sonarr Settings -->
                        <div class="advanced-section">
                            <h3 style="margin-top: 0;">Sonarr Configuration</h3>
                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label class="emby-checkbox-label">
                                    <input id="EnableNativeSonarrIntegration" name="EnableNativeSonarrIntegration" type="checkbox" is="emby-checkbox" />
                                    <span>Enable Sonarr Integration</span>
                                </label>
                                <div class="fieldDescription">Enable automatic TV show monitoring management through Sonarr.</div>
                            </div>
                            <div class="inputContainer">
                                <label class="inputLabel inputLabelUnfocused" for="SonarrUrl">Sonarr URL</label>
                                <input id="SonarrUrl" name="SonarrUrl" type="text" is="emby-input" placeholder="http://localhost:8989" />
                                <div class="fieldDescription">The URL of your Sonarr instance (e.g., http://localhost:8989).</div>
                            </div>
                            <div class="inputContainer">
                                <label class="inputLabel inputLabelUnfocused" for="SonarrApiKey">Sonarr API Key</label>
                                <input id="SonarrApiKey" name="SonarrApiKey" type="password" is="emby-input" />
                                <div class="fieldDescription">Your Sonarr API key (found in Settings → General → Security).</div>
                            </div>
                            <div class="inputContainer">
                                <button id="testSonarrConnection" type="button" is="emby-button" class="raised button-submit" style="margin-bottom: 10px;">
                                    <span id="testSonarrText">Test Sonarr Connection</span>
                                </button>
                                <div id="sonarrTestResult" class="fieldDescription" style="display: none; font-weight: bold;"></div>
                            </div>
                            <div class="inputContainer">
                                <label class="inputLabel inputLabelUnfocused" for="EpisodeDownloadBuffer">Episode Buffer</label>
                                <input id="EpisodeDownloadBuffer" name="EpisodeDownloadBuffer" type="number" is="emby-input" min="1" max="20" />
                                <div class="fieldDescription">Number of episodes to monitor ahead of your current position. When you watch an episode, the plugin will monitor this many episodes forward from where you are (default: 6).</div>
                            </div>
                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label class="emby-checkbox-label">
                                    <input id="AutoSearchEpisodes" name="AutoSearchEpisodes" type="checkbox" is="emby-checkbox" />
                                    <span>Auto-Search Episodes</span>
                                </label>
                                <div class="fieldDescription">Automatically trigger searches for newly monitored episodes in Sonarr.</div>
                            </div>
                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label class="emby-checkbox-label">
                                    <input id="MonitorFutureEpisodes" name="MonitorFutureEpisodes" type="checkbox" is="emby-checkbox" />
                                    <span>Monitor Future Episodes</span>
                                </label>
                                <div class="fieldDescription">Automatically monitor future episodes when they are added to Sonarr.</div>
                            </div>
                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label class="emby-checkbox-label">
                                    <input id="SkipEpisodesWithFiles" name="SkipEpisodesWithFiles" type="checkbox" is="emby-checkbox" />
                                    <span>Skip Episodes With Files</span>
                                </label>
                                <div class="fieldDescription">Only monitor episodes that don't have files yet. Disable to re-monitor all episodes (useful for quality upgrades).</div>
                            </div>
                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label class="emby-checkbox-label">
                                    <input id="UnmonitorWatchedEpisodes" name="UnmonitorWatchedEpisodes" type="checkbox" is="emby-checkbox" />
                                    <span>Unmonitor Watched Episodes</span>
                                </label>
                                <div class="fieldDescription">Unmonitor episodes after they are watched. Disable to keep all episodes monitored.</div>
                            </div>
                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label class="emby-checkbox-label">
                                    <input id="MonitorOnlyCurrentSeason" name="MonitorOnlyCurrentSeason" type="checkbox" is="emby-checkbox" />
                                    <span>Monitor Only Current Season</span>
                                </label>
                                <div class="fieldDescription">When enabled, only monitors episodes in the same season you're currently watching. Future seasons won't be monitored until you start watching them.</div>
                            </div>
                        </div>

                        <!-- Radarr Settings -->
                        <div class="advanced-section" style="margin-top: 20px;">
                            <h3 style="margin-top: 0;">Radarr Configuration</h3>
                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label class="emby-checkbox-label">
                                    <input id="EnableNativeRadarrIntegration" name="EnableNativeRadarrIntegration" type="checkbox" is="emby-checkbox" />
                                    <span>Enable Radarr Integration</span>
                                </label>
                                <div class="fieldDescription">Enable automatic movie monitoring management through Radarr.</div>
                            </div>
                            <div class="inputContainer">
                                <label class="inputLabel inputLabelUnfocused" for="RadarrUrl">Radarr URL</label>
                                <input id="RadarrUrl" name="RadarrUrl" type="text" is="emby-input" placeholder="http://localhost:7878" />
                                <div class="fieldDescription">The URL of your Radarr instance (e.g., http://localhost:7878).</div>
                            </div>
                            <div class="inputContainer">
                                <label class="inputLabel inputLabelUnfocused" for="RadarrApiKey">Radarr API Key</label>
                                <input id="RadarrApiKey" name="RadarrApiKey" type="password" is="emby-input" />
                                <div class="fieldDescription">Your Radarr API key (found in Settings → General → Security).</div>
                            </div>
                            <div class="inputContainer">
                                <button id="testRadarrConnection" type="button" is="emby-button" class="raised button-submit" style="margin-bottom: 10px;">
                                    <span id="testRadarrText">Test Radarr Connection</span>
                                </button>
                                <div id="radarrTestResult" class="fieldDescription" style="display: none; font-weight: bold;"></div>
                            </div>
                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label class="emby-checkbox-label">
                                    <input id="UnmonitorWatchedMovies" name="UnmonitorWatchedMovies" type="checkbox" is="emby-checkbox" />
                                    <span>Unmonitor Watched Movies</span>
                                </label>
                                <div class="fieldDescription">Automatically set movies to unmonitored in Radarr after they are watched.</div>
                            </div>
                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label class="emby-checkbox-label">
                                    <input id="UnmonitorOnlyIfWatched" name="UnmonitorOnlyIfWatched" type="checkbox" is="emby-checkbox" />
                                    <span>Unmonitor Only If Actually Watched</span>
                                </label>
                                <div class="fieldDescription">Only unmonitor movies if the user watched at least the configured percentage. Requires PlaybackStop event.</div>
                            </div>
                            <div class="inputContainer">
                                <label class="inputLabel inputLabelUnfocused" for="MinimumWatchPercentage">Minimum Watch Percentage</label>
                                <input id="MinimumWatchPercentage" name="MinimumWatchPercentage" type="number" is="emby-input" min="0" max="100" />
                                <div class="fieldDescription">Minimum percentage of the movie that must be watched to consider it "watched" (default: 90).</div>
                            </div>
                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label class="emby-checkbox-label">
                                    <input id="UnmonitorAfterUpgrade" name="UnmonitorAfterUpgrade" type="checkbox" is="emby-checkbox" />
                                    <span>Unmonitor After Quality Cutoff</span>
                                </label>
                                <div class="fieldDescription">Only unmonitor movies that have reached their quality cutoff (no upgrade possible).</div>
                            </div>
                        </div>
                    </div>

                    <!-- Global Settings Tab -->
                    <div id="global-tab" class="tab-content" style="display: none;">
                        <div class="section-title" style="margin-bottom: 20px;">Global Execution Settings</div>
                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="MaxConcurrentExecutions">Max concurrent executions</label>
                            <input id="MaxConcurrentExecutions" name="MaxConcurrentExecutions" type="number" is="emby-input" min="1" max="20" />
                            <div class="fieldDescription">Maximum number of scripts that can run simultaneously.</div>
                        </div>
                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="DefaultTimeoutSeconds">Default timeout (seconds)</label>
                            <input id="DefaultTimeoutSeconds" name="DefaultTimeoutSeconds" type="number" is="emby-input" min="30" />
                            <div class="fieldDescription">Default timeout for script execution when not specified in individual settings.</div>
                        </div>
                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="QueueSize">Queue size</label>
                            <input id="QueueSize" name="QueueSize" type="number" is="emby-input" min="10" />
                            <div class="fieldDescription">Maximum number of pending script executions to queue.</div>
                        </div>
                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label class="emby-checkbox-label">
                                <input id="EnableVerboseLogging" name="EnableVerboseLogging" type="checkbox" is="emby-checkbox" />
                                <span>Enable verbose logging</span>
                            </label>
                            <div class="fieldDescription">Log detailed information about script execution for debugging.</div>
                        </div>
                    </div>

                    <div style="margin-top: 30px;">
                        <button is="emby-button" type="submit" class="raised button-submit block emby-button">
                            <span>Save</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <script type="text/javascript">
            var JellyPyConfig = {
                pluginUniqueId: 'a5bd541f-38dc-467e-9a9a-15fe3f3bcf5c',
                currentConfig: null,
                selectedScriptId: null,
                scriptSettings: []
            };

            // Script Management Functions
            function addNewScript() {
                var newScript = {
                    Id: generateGuid(),
                    Name: 'New Script',
                    Description: '',
                    Enabled: true,
                    Triggers: [],
                    Conditions: [],
                    Execution: {
                        ExecutorType: 0, // Python
                        ExecutablePath: '/usr/bin/python3',
                        ScriptPath: '',
                        WorkingDirectory: '',
                        AdditionalArguments: '',
                        EnvironmentVariables: [],
                        TimeoutSeconds: 300
                    },
                    DataAttributes: [],
                    Priority: 100
                };
                
                JellyPyConfig.scriptSettings.push(newScript);
                renderScriptList();
                selectScript(newScript.Id);
            }

            function deleteScript(scriptId) {
                if (confirm('Are you sure you want to delete this script?')) {
                    JellyPyConfig.scriptSettings = JellyPyConfig.scriptSettings.filter(s => s.Id !== scriptId);
                    
                    if (JellyPyConfig.selectedScriptId === scriptId) {
                        JellyPyConfig.selectedScriptId = null;
                        renderScriptDetails();
                    }
                    
                    renderScriptList();
                }
            }

            function selectScript(scriptId) {
                JellyPyConfig.selectedScriptId = scriptId;
                
                // Update active state in list
                document.querySelectorAll('.script-item').forEach(function(item) {
                    item.classList.remove('active');
                });
                
                var selectedItem = document.querySelector('[data-script-id="' + scriptId + '"]');
                if (selectedItem) {
                    selectedItem.classList.add('active');
                }
                
                renderScriptDetails();
            }

            function renderScriptList() {
                var container = document.getElementById('scriptItems');
                var emptyState = document.getElementById('emptyState');
                
                if (JellyPyConfig.scriptSettings.length === 0) {
                    emptyState.style.display = 'block';
                    return;
                }
                
                emptyState.style.display = 'none';
                container.innerHTML = '';
                
                JellyPyConfig.scriptSettings.forEach(function(script) {
                    var statusClass = script.Enabled ? 'status-enabled' : 'status-disabled';
                    var statusText = script.Enabled ? 'Enabled' : 'Disabled';
                    var activeClass = script.Id === JellyPyConfig.selectedScriptId ? 'active' : '';
                    
                    var scriptItem = document.createElement('div');
                    scriptItem.className = 'script-item ' + activeClass;
                    scriptItem.setAttribute('data-script-id', script.Id);
                    scriptItem.onclick = function() { selectScript(script.Id); };
                    
                    var info = document.createElement('div');
                    info.className = 'script-item-info';
                    
                    var name = document.createElement('div');
                    name.className = 'script-item-name';
                    name.textContent = script.Name;
                    
                    var desc = document.createElement('div');
                    desc.className = 'script-item-desc';
                    desc.textContent = script.Description || 'No description';
                    
                    info.appendChild(name);
                    info.appendChild(desc);
                    
                    var status = document.createElement('div');
                    status.className = 'script-item-status';
                    
                    var statusSpan = document.createElement('span');
                    statusSpan.className = statusClass;
                    statusSpan.textContent = statusText;
                    
                    var deleteBtn = document.createElement('button');
                    deleteBtn.type = 'button';
                    deleteBtn.className = 'delete-script-btn';
                    deleteBtn.textContent = '×';
                    deleteBtn.onclick = function(e) {
                        e.stopPropagation();
                        deleteScript(script.Id);
                    };
                    
                    status.appendChild(statusSpan);
                    status.appendChild(deleteBtn);
                    
                    scriptItem.appendChild(info);
                    scriptItem.appendChild(status);
                    
                    container.appendChild(scriptItem);
                });
            }

            function renderScriptDetails() {
                var noScriptDiv = document.getElementById('noScriptSelected');
                var formDiv = document.getElementById('scriptForm');
                var header = document.getElementById('scriptDetailsHeader');
                
                if (!JellyPyConfig.selectedScriptId) {
                    header.textContent = 'Script Details';
                    noScriptDiv.style.display = 'block';
                    formDiv.style.display = 'none';
                    return;
                }
                
                var script = JellyPyConfig.scriptSettings.find(s => s.Id === JellyPyConfig.selectedScriptId);
                if (!script) {
                    return;
                }
                
                // Show form, hide "no script" message
                noScriptDiv.style.display = 'none';
                formDiv.style.display = 'block';
                header.textContent = script.Name + ' - Details';
                
                // Populate basic fields
                document.getElementById('script-name').value = script.Name;
                document.getElementById('script-name').onchange = function() { updateScriptProperty('Name', this.value); };
                
                document.getElementById('script-priority').value = script.Priority;
                document.getElementById('script-priority').onchange = function() { updateScriptProperty('Priority', parseInt(this.value)); };
                
                document.getElementById('script-description').value = script.Description;
                document.getElementById('script-description').onchange = function() { updateScriptProperty('Description', this.value); };
                
                document.getElementById('script-enabled').checked = script.Enabled;
                document.getElementById('script-enabled').onchange = function() { updateScriptProperty('Enabled', this.checked); };
                
                // Populate sections using existing render functions
                document.getElementById('triggerCheckboxes').innerHTML = renderTriggerCheckboxes(script.Triggers);
                document.getElementById('executionSettingsContent').innerHTML = renderExecutionSettings(script.Execution);
                document.getElementById('conditionsContainer').innerHTML = renderConditions(script.Conditions);
                document.getElementById('dataAttributesContainer').innerHTML = renderDataAttributes(script.DataAttributes);
            }

            function toggleCollapsible(header) {
                var content = header.nextElementSibling;
                var toggle = header.querySelector('.collapsible-toggle');
                
                if (content.classList.contains('expanded')) {
                    content.classList.remove('expanded');
                    toggle.classList.remove('expanded');
                } else {
                    content.classList.add('expanded');
                    toggle.classList.add('expanded');
                }
            }

            function updateScriptProperty(property, value) {
                var script = JellyPyConfig.scriptSettings.find(s => s.Id === JellyPyConfig.selectedScriptId);
                if (script) {
                    script[property] = value;
                    if (property === 'Name' || property === 'Enabled') {
                        renderScriptList();
                    }
                }
            }

            function renderTriggerCheckboxes(triggers) {
                var eventTypes = [
                    { value: 0, name: 'PlaybackStart', label: 'Playback Start' },
                    { value: 1, name: 'PlaybackStop', label: 'Playback Stop' },
                    { value: 2, name: 'PlaybackPause', label: 'Playback Pause' },
                    { value: 3, name: 'PlaybackResume', label: 'Playback Resume' },
                    { value: 4, name: 'ItemAdded', label: 'Item Added' },
                    { value: 5, name: 'ItemUpdated', label: 'Item Updated' },
                    { value: 6, name: 'ItemRemoved', label: 'Item Removed' },
                    { value: 7, name: 'UserCreated', label: 'User Created' },
                    { value: 8, name: 'UserUpdated', label: 'User Updated' },
                    { value: 9, name: 'UserDeleted', label: 'User Deleted' },
                    { value: 10, name: 'SessionStart', label: 'Session Start' },
                    { value: 11, name: 'SessionEnd', label: 'Session End' },
                    { value: 12, name: 'ServerStartup', label: 'Server Startup' },
                    { value: 13, name: 'ServerShutdown', label: 'Server Shutdown' }
                ];
                
                var html = '';
                eventTypes.forEach(function(eventType) {
                    var checked = triggers.includes(eventType.value) ? 'checked' : '';
                    html += '<div class="trigger-checkbox">' +
                            '<input type="checkbox" id="trigger-' + eventType.value + '" ' + checked + ' ' +
                                   'onchange="updateTrigger(' + eventType.value + ', this.checked)" />' +
                            '<label for="trigger-' + eventType.value + '">' + eventType.label + '</label>' +
                        '</div>';
                });
                return html;
            }

            function updateTrigger(eventType, checked) {
                var script = JellyPyConfig.scriptSettings.find(s => s.Id === JellyPyConfig.selectedScriptId);
                if (!script) return;
                
                if (checked) {
                    if (!script.Triggers.includes(eventType)) {
                        script.Triggers.push(eventType);
                    }
                } else {
                    script.Triggers = script.Triggers.filter(t => t !== eventType);
                }
            }

            function renderExecutionSettings(execution) {
                var executorTypes = [
                    { value: 0, label: 'Python' },
                    { value: 1, label: 'PowerShell' },
                    { value: 2, label: 'Bash' },
                    { value: 3, label: 'Node.js' },
                    { value: 4, label: 'Binary' }
                ];
                
                var executorOptions = '';
                executorTypes.forEach(function(type) {
                    var selected = execution.ExecutorType === type.value ? 'selected' : '';
                    executorOptions += '<option value="' + type.value + '" ' + selected + '>' + type.label + '</option>';
                });
                
                var html = '<div class="form-row">' +
                        '<div class="form-col">' +
                            '<label class="inputLabel inputLabelUnfocused" for="executor-type">Executor Type</label>' +
                            '<select id="executor-type" is="emby-select" onchange="updateExecutionProperty(\'ExecutorType\', parseInt(this.value))">' +
                                executorOptions +
                            '</select>' +
                        '</div>' +
                        '<div class="form-col">' +
                            '<label class="inputLabel inputLabelUnfocused" for="timeout-seconds">Timeout (seconds)</label>' +
                            '<input id="timeout-seconds" type="number" is="emby-input" min="30" max="3600" ' +
                                   'value="' + execution.TimeoutSeconds + '" onchange="updateExecutionProperty(\'TimeoutSeconds\', parseInt(this.value))" />' +
                        '</div>' +
                    '</div>' +
                    '<div class="inputContainer">' +
                        '<label class="inputLabel inputLabelUnfocused" for="executable-path">Executable Path</label>' +
                        '<input id="executable-path" type="text" is="emby-input" ' +
                               'value="' + escapeHtml(execution.ExecutablePath) + '" onchange="updateExecutionProperty(\'ExecutablePath\', this.value)" />' +
                        '<div class="fieldDescription">Path to the interpreter or executable (e.g., /usr/bin/python3, powershell, /bin/bash)</div>' +
                    '</div>' +
                    '<div class="inputContainer">' +
                        '<label class="inputLabel inputLabelUnfocused" for="script-path">Script Path</label>' +
                        '<input id="script-path" type="text" is="emby-input" ' +
                               'value="' + escapeHtml(execution.ScriptPath) + '" onchange="updateExecutionProperty(\'ScriptPath\', this.value)" />' +
                        '<div class="fieldDescription">Full path to your script file</div>' +
                    '</div>' +
                    '<div class="inputContainer">' +
                        '<label class="inputLabel inputLabelUnfocused" for="working-directory">Working Directory</label>' +
                        '<input id="working-directory" type="text" is="emby-input" ' +
                               'value="' + escapeHtml(execution.WorkingDirectory) + '" onchange="updateExecutionProperty(\'WorkingDirectory\', this.value)" />' +
                        '<div class="fieldDescription">Directory to run the script from (optional)</div>' +
                    '</div>' +
                    '<div class="inputContainer">' +
                        '<label class="inputLabel inputLabelUnfocused" for="additional-arguments">Additional Arguments</label>' +
                        '<input id="additional-arguments" type="text" is="emby-input" ' +
                               'value="' + escapeHtml(execution.AdditionalArguments) + '" onchange="updateExecutionProperty(\'AdditionalArguments\', this.value)" />' +
                        '<div class="fieldDescription">Extra command line arguments (optional)</div>' +
                    '</div>';
                return html;
            }

            function updateExecutionProperty(property, value) {
                var script = JellyPyConfig.scriptSettings.find(s => s.Id === JellyPyConfig.selectedScriptId);
                if (script) {
                    script.Execution[property] = value;
                }
            }

            function renderConditions(conditions) {
                if (conditions.length === 0) {
                    return '<div style="color: #888; font-style: italic; text-align: center; padding: 20px;">No conditions configured. Script will run for all matching events.</div>';
                }
                
                var html = '';
                conditions.forEach(function(condition, index) {
                    html += '<div class="condition-item">';
                    html += '<button type="button" class="remove-item-btn" onclick="removeCondition(' + index + ')">&times;</button>';
                    html += '<div class="form-row">';
                    html += '<div class="form-col">';
                    html += '<label class="inputLabel inputLabelUnfocused">Field</label>';
                    html += '<input type="text" is="emby-input" value="' + escapeHtml(condition.Field) + '" ';
                    html += 'onchange="updateCondition(' + index + ', \'Field\', this.value)" ';
                    html += 'placeholder="e.g., User.Name, Item.Type, etc." />';
                    html += '</div>';
                    html += '<div class="form-col-narrow">';
                    html += '<label class="inputLabel inputLabelUnfocused">Operator</label>';
                    html += '<select is="emby-select" onchange="updateCondition(' + index + ', \'Operator\', parseInt(this.value))">';
                    html += renderOperatorOptions(condition.Operator);
                    html += '</select>';
                    html += '</div>';
                    html += '<div class="form-col">';
                    html += '<label class="inputLabel inputLabelUnfocused">Value</label>';
                    html += '<input type="text" is="emby-input" value="' + escapeHtml(condition.Value) + '" ';
                    html += 'onchange="updateCondition(' + index + ', \'Value\', this.value)" />';
                    html += '</div>';
                    html += '</div>';
                    html += '<div class="checkboxContainer">';
                    html += '<label class="emby-checkbox-label">';
                    html += '<input type="checkbox" is="emby-checkbox" ' + (condition.CaseSensitive ? 'checked' : '') + ' ';
                    html += 'onchange="updateCondition(' + index + ', \'CaseSensitive\', this.checked)" />';
                    html += '<span>Case Sensitive</span>';
                    html += '</label>';
                    html += '</div>';
                    html += '</div>';
                });
                return html;
            }

            function renderOperatorOptions(selectedOperator) {
                var operators = [
                    { value: 0, label: 'Equals' },
                    { value: 1, label: 'Not Equals' },
                    { value: 2, label: 'Contains' },
                    { value: 3, label: 'Not Contains' },
                    { value: 4, label: 'Starts With' },
                    { value: 5, label: 'Ends With' },
                    { value: 6, label: 'Regex' },
                    { value: 7, label: 'Greater Than' },
                    { value: 8, label: 'Less Than' },
                    { value: 9, label: 'In List' },
                    { value: 10, label: 'Not In List' }
                ];
                
                var html = '';
                operators.forEach(function(op) {
                    var selected = selectedOperator === op.value ? 'selected' : '';
                    html += '<option value="' + op.value + '" ' + selected + '>' + op.label + '</option>';
                });
                return html;
            }

            function addCondition() {
                var script = JellyPyConfig.scriptSettings.find(s => s.Id === JellyPyConfig.selectedScriptId);
                if (script) {
                    script.Conditions.push({
                        Field: '',
                        Operator: 0, // Equals
                        Value: '',
                        CaseSensitive: false
                    });
                    renderScriptDetails();
                }
            }

            function removeCondition(index) {
                var script = JellyPyConfig.scriptSettings.find(s => s.Id === JellyPyConfig.selectedScriptId);
                if (script) {
                    script.Conditions.splice(index, 1);
                    renderScriptDetails();
                }
            }

            function updateCondition(index, property, value) {
                var script = JellyPyConfig.scriptSettings.find(s => s.Id === JellyPyConfig.selectedScriptId);
                if (script && script.Conditions[index]) {
                    script.Conditions[index][property] = value;
                }
            }

            function renderDataAttributes(dataAttributes) {
                if (dataAttributes.length === 0) {
                    return '<div style="color: #888; font-style: italic; text-align: center; padding: 20px;">No data attributes configured. Event data will be passed as JSON.</div>';
                }
                
                var html = '';
                dataAttributes.forEach(function(attr, index) {
                    html += '<div class="data-attribute-item">';
                    html += '<button type="button" class="remove-item-btn" onclick="removeDataAttribute(' + index + ')">&times;</button>';
                    html += '<div class="form-row">';
                    html += '<div class="form-col">';
                    html += '<label class="inputLabel inputLabelUnfocused">Attribute Name</label>';
                    html += '<input type="text" is="emby-input" value="' + escapeHtml(attr.Name) + '" ';
                    html += 'onchange="updateDataAttribute(' + index + ', \'Name\', this.value)" ';
                    html += 'placeholder="Variable name in script" />';
                    html += '</div>';
                    html += '<div class="form-col">';
                    html += '<label class="inputLabel inputLabelUnfocused">Source Field</label>';
                    html += '<input type="text" is="emby-input" value="' + escapeHtml(attr.SourceField) + '" ';
                    html += 'onchange="updateDataAttribute(' + index + ', \'SourceField\', this.value)" ';
                    html += 'placeholder="e.g., User.Name, Item.Id" />';
                    html += '</div>';
                    html += '</div>';
                    html += '<div class="form-row">';
                    html += '<div class="form-col">';
                    html += '<label class="inputLabel inputLabelUnfocused">Format</label>';
                    html += '<select is="emby-select" onchange="updateDataAttribute(' + index + ', \'Format\', parseInt(this.value))">';
                    html += renderFormatOptions(attr.Format);
                    html += '</select>';
                    html += '</div>';
                    html += '<div class="form-col">';
                    html += '<label class="inputLabel inputLabelUnfocused">Default Value</label>';
                    html += '<input type="text" is="emby-input" value="' + escapeHtml(attr.DefaultValue) + '" ';
                    html += 'onchange="updateDataAttribute(' + index + ', \'DefaultValue\', this.value)" />';
                    html += '</div>';
                    html += '</div>';
                    html += '<div class="checkboxContainer">';
                    html += '<label class="emby-checkbox-label">';
                    html += '<input type="checkbox" is="emby-checkbox" ' + (attr.Required ? 'checked' : '') + ' ';
                    html += 'onchange="updateDataAttribute(' + index + ', \'Required\', this.checked)" />';
                    html += '<span>Required</span>';
                    html += '</label>';
                    html += '</div>';
                    html += '</div>';
                });
                return html;
            }

            function renderFormatOptions(selectedFormat) {
                var formats = [
                    { value: 0, label: 'String' },
                    { value: 1, label: 'JSON' },
                    { value: 2, label: 'Environment Variable' },
                    { value: 3, label: 'Command Argument' }
                ];
                
                var html = '';
                formats.forEach(function(format) {
                    var selected = selectedFormat === format.value ? 'selected' : '';
                    html += '<option value="' + format.value + '" ' + selected + '>' + format.label + '</option>';
                });
                return html;
            }

            function addDataAttribute() {
                var script = JellyPyConfig.scriptSettings.find(s => s.Id === JellyPyConfig.selectedScriptId);
                if (script) {
                    script.DataAttributes.push({
                        Name: '',
                        SourceField: '',
                        Format: 0, // String
                        Required: false,
                        DefaultValue: ''
                    });
                    renderScriptDetails();
                }
            }

            function removeDataAttribute(index) {
                var script = JellyPyConfig.scriptSettings.find(s => s.Id === JellyPyConfig.selectedScriptId);
                if (script) {
                    script.DataAttributes.splice(index, 1);
                    renderScriptDetails();
                }
            }

            function updateDataAttribute(index, property, value) {
                var script = JellyPyConfig.scriptSettings.find(s => s.Id === JellyPyConfig.selectedScriptId);
                if (script && script.DataAttributes[index]) {
                    script.DataAttributes[index][property] = value;
                }
            }

            function renderEnvironmentVariables(envVars) {
                if (envVars.length === 0) {
                    return '<div style="color: #888; font-style: italic; text-align: center; padding: 20px;">No environment variables configured.</div>';
                }
                
                var html = '';
                envVars.forEach(function(envVar, index) {
                    html += '<div class="env-var-item">';
                    html += '<button type="button" class="remove-item-btn" onclick="removeEnvironmentVariable(' + index + ')">&times;</button>';
                    html += '<div class="form-row">';
                    html += '<div class="form-col">';
                    html += '<label class="inputLabel inputLabelUnfocused">Variable Name</label>';
                    html += '<input type="text" is="emby-input" value="' + escapeHtml(envVar.Name) + '" ';
                    html += 'onchange="updateEnvironmentVariable(' + index + ', \'Name\', this.value)" />';
                    html += '</div>';
                    html += '<div class="form-col">';
                    html += '<label class="inputLabel inputLabelUnfocused">Value</label>';
                    html += '<input type="text" is="emby-input" value="' + escapeHtml(envVar.Value) + '" ';
                    html += 'onchange="updateEnvironmentVariable(' + index + ', \'Value\', this.value)" />';
                    html += '</div>';
                    html += '</div>';
                    html += '</div>';
                });
                return html;
            }

            function addEnvironmentVariable() {
                var script = JellyPyConfig.scriptSettings.find(s => s.Id === JellyPyConfig.selectedScriptId);
                if (script) {
                    script.Execution.EnvironmentVariables.push({
                        Name: '',
                        Value: ''
                    });
                    renderScriptDetails();
                }
            }

            function removeEnvironmentVariable(index) {
                var script = JellyPyConfig.scriptSettings.find(s => s.Id === JellyPyConfig.selectedScriptId);
                if (script) {
                    script.Execution.EnvironmentVariables.splice(index, 1);
                    renderScriptDetails();
                }
            }

            function updateEnvironmentVariable(index, property, value) {
                var script = JellyPyConfig.scriptSettings.find(s => s.Id === JellyPyConfig.selectedScriptId);
                if (script && script.Execution.EnvironmentVariables[index]) {
                    script.Execution.EnvironmentVariables[index][property] = value;
                }
            }

            // Tab Management
            function switchTab(tabName) {
                // Hide all tab contents
                document.querySelectorAll('.tab-content').forEach(function(content) {
                    content.style.display = 'none';
                });

                // Remove active class from all tab buttons
                document.querySelectorAll('.tab-button').forEach(function(button) {
                    button.classList.remove('active');
                });

                // Show the selected tab content
                var targetTab = document.getElementById(tabName + '-tab');
                if (targetTab) {
                    targetTab.style.display = 'block';
                }

                // Add active class to the button that matches this tab
                var targetButton = document.querySelector(".tab-button[onclick*=\"'" + tabName + "'\"]");
                if (targetButton) {
                    targetButton.classList.add('active');
                }
            }

            // Utility functions
            function escapeHtml(text) {
                if (text === null || text === undefined) return '';
                return text.toString().replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
            }

            function generateGuid() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    var r = Math.random() * 16 | 0,
                        v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }

            // API Key Loading Function
            async function loadApiKeys() {
                try {
                    const response = await ApiClient.ajax({
                        type: 'GET',
                        url: ApiClient.getUrl('/Plugins/Jellypy/api-keys')
                    });

                    let apiKeys = response;
                    if (response instanceof Response) {
                        if (response.ok) {
                            apiKeys = await response.json();
                        } else {
                            console.error('Failed to load API keys:', response.status);
                            return;
                        }
                    }

                    // Load decrypted API keys into the form fields
                    document.querySelector('#SonarrApiKey').value = apiKeys.SonarrApiKey || '';
                    document.querySelector('#RadarrApiKey').value = apiKeys.RadarrApiKey || '';
                } catch (error) {
                    console.error('Error loading API keys:', error);
                }
            }

            // Connection Test Function
            async function testConnection(type) {
                const isSonarr = type === 'sonarr';
                const buttonId = isSonarr ? 'testSonarrConnection' : 'testRadarrConnection';
                const textId = isSonarr ? 'testSonarrText' : 'testRadarrText';
                const resultId = isSonarr ? 'sonarrTestResult' : 'radarrTestResult';
                const urlId = isSonarr ? 'SonarrUrl' : 'RadarrUrl';
                const apiKeyId = isSonarr ? 'SonarrApiKey' : 'RadarrApiKey';
                const endpoint = isSonarr ? '/Plugins/Jellypy/test-sonarr' : '/Plugins/Jellypy/test-radarr';

                const button = document.getElementById(buttonId);
                const textElement = document.getElementById(textId);
                const resultElement = document.getElementById(resultId);
                const urlElement = document.getElementById(urlId);
                const apiKeyElement = document.getElementById(apiKeyId);

                const url = urlElement.value.trim();
                const apiKey = apiKeyElement.value.trim();

                if (!url || !apiKey) {
                    showTestResult(resultElement, false, 'Please enter both URL and API Key');
                    return;
                }

                // Disable button and show loading
                button.disabled = true;
                textElement.textContent = 'Testing...';
                resultElement.style.display = 'none';

                try {
                    const response = await ApiClient.ajax({
                        type: 'POST',
                        url: ApiClient.getUrl(endpoint),
                        data: JSON.stringify({ Url: url, ApiKey: apiKey }),
                        contentType: 'application/json'
                    });

                    let result = response;
                    if (response instanceof Response) {
                        result = await response.json();
                    }

                    showTestResult(resultElement, result.Success, result.Message);
                } catch (error) {
                    console.error(type + ' test error:', error);
                    showTestResult(resultElement, false, `Test failed: ${error.message || 'Unknown error'}`);
                } finally {
                    // Re-enable button
                    button.disabled = false;
                    textElement.textContent = 'Test ' + (isSonarr ? 'Sonarr' : 'Radarr') + ' Connection';
                }
            }

            // Connection Test Functions
            async function testSonarrConnection() {
                await testConnection('sonarr');
            }

            async function testRadarrConnection() {
                await testConnection('radarr');
            }

            function showTestResult(element, success, message) {
                element.style.display = 'block';
                element.textContent = message;
                element.style.color = success ? '#4CAF50' : '#f44336';
            }

            // Page initialization
            document.querySelector('#JellyPyConfigPage')
                .addEventListener('pageshow', function() {
                    Dashboard.showLoadingMsg();
                    ApiClient.getPluginConfiguration(JellyPyConfig.pluginUniqueId).then(function (config) {
                        JellyPyConfig.currentConfig = config;

                        // Load global settings
                        var globalSettings = config.GlobalSettings || {};
                        document.querySelector('#MaxConcurrentExecutions').value = globalSettings.MaxConcurrentExecutions || 5;
                        document.querySelector('#DefaultTimeoutSeconds').value = globalSettings.DefaultTimeoutSeconds || 300;
                        document.querySelector('#QueueSize').value = globalSettings.QueueSize || 100;
                        document.querySelector('#EnableVerboseLogging').checked = globalSettings.EnableVerboseLogging || false;

                        // Load native integration settings
                        document.querySelector('#EnableNativeSonarrIntegration').checked = config.EnableNativeSonarrIntegration !== undefined ? config.EnableNativeSonarrIntegration : true;
                        document.querySelector('#SonarrUrl').value = config.SonarrUrl || '';
                        // API key will be loaded separately via API call
                        document.querySelector('#EpisodeDownloadBuffer').value = config.EpisodeDownloadBuffer || 6;
                        document.querySelector('#AutoSearchEpisodes').checked = config.AutoSearchEpisodes !== undefined ? config.AutoSearchEpisodes : true;
                        document.querySelector('#MonitorFutureEpisodes').checked = config.MonitorFutureEpisodes !== undefined ? config.MonitorFutureEpisodes : true;
                        document.querySelector('#SkipEpisodesWithFiles').checked = config.SkipEpisodesWithFiles !== undefined ? config.SkipEpisodesWithFiles : true;
                        document.querySelector('#UnmonitorWatchedEpisodes').checked = config.UnmonitorWatchedEpisodes !== undefined ? config.UnmonitorWatchedEpisodes : true;
                        document.querySelector('#MonitorOnlyCurrentSeason').checked = config.MonitorOnlyCurrentSeason !== undefined ? config.MonitorOnlyCurrentSeason : false;

                        document.querySelector('#EnableNativeRadarrIntegration').checked = config.EnableNativeRadarrIntegration !== undefined ? config.EnableNativeRadarrIntegration : true;
                        document.querySelector('#RadarrUrl').value = config.RadarrUrl || '';
                        // API key will be loaded separately via API call
                        document.querySelector('#UnmonitorWatchedMovies').checked = config.UnmonitorWatchedMovies !== undefined ? config.UnmonitorWatchedMovies : true;
                        document.querySelector('#UnmonitorOnlyIfWatched').checked = config.UnmonitorOnlyIfWatched !== undefined ? config.UnmonitorOnlyIfWatched : false;
                        document.querySelector('#MinimumWatchPercentage').value = config.MinimumWatchPercentage || 90;
                        document.querySelector('#UnmonitorAfterUpgrade').checked = config.UnmonitorAfterUpgrade !== undefined ? config.UnmonitorAfterUpgrade : false;

                        // Initialize script settings placeholder
                        JellyPyConfig.scriptSettings = config.ScriptSettings || [];
                        renderScriptList();

                        // Load decrypted API keys separately
                        loadApiKeys();

                        // Add test connection button event listeners
                        document.getElementById('testSonarrConnection').addEventListener('click', testSonarrConnection);
                        document.getElementById('testRadarrConnection').addEventListener('click', testRadarrConnection);

                        Dashboard.hideLoadingMsg();
                    });
                });

            document.querySelector('#JellyPyConfigForm')
                .addEventListener('submit', function(e) {
                    Dashboard.showLoadingMsg();

                    var config = JellyPyConfig.currentConfig;

                    // Save global settings
                    if (!config.GlobalSettings) {
                        config.GlobalSettings = {};
                    }
                    config.GlobalSettings.MaxConcurrentExecutions = parseInt(document.querySelector('#MaxConcurrentExecutions').value || 5, 10);
                    config.GlobalSettings.DefaultTimeoutSeconds = parseInt(document.querySelector('#DefaultTimeoutSeconds').value || 300, 10);
                    config.GlobalSettings.QueueSize = parseInt(document.querySelector('#QueueSize').value || 100, 10);
                    config.GlobalSettings.EnableVerboseLogging = document.querySelector('#EnableVerboseLogging').checked;

                    // Save native integration settings
                    config.EnableNativeSonarrIntegration = document.querySelector('#EnableNativeSonarrIntegration').checked;
                    config.SonarrUrl = document.querySelector('#SonarrUrl').value;
                    config.SonarrApiKeyEncrypted = document.querySelector('#SonarrApiKey').value;
                    config.EpisodeDownloadBuffer = parseInt(document.querySelector('#EpisodeDownloadBuffer').value || 6, 10);
                    config.AutoSearchEpisodes = document.querySelector('#AutoSearchEpisodes').checked;
                    config.MonitorFutureEpisodes = document.querySelector('#MonitorFutureEpisodes').checked;
                    config.SkipEpisodesWithFiles = document.querySelector('#SkipEpisodesWithFiles').checked;
                    config.UnmonitorWatchedEpisodes = document.querySelector('#UnmonitorWatchedEpisodes').checked;
                    config.MonitorOnlyCurrentSeason = document.querySelector('#MonitorOnlyCurrentSeason').checked;

                    config.EnableNativeRadarrIntegration = document.querySelector('#EnableNativeRadarrIntegration').checked;
                    config.RadarrUrl = document.querySelector('#RadarrUrl').value;
                    config.RadarrApiKeyEncrypted = document.querySelector('#RadarrApiKey').value;
                    config.UnmonitorWatchedMovies = document.querySelector('#UnmonitorWatchedMovies').checked;
                    config.UnmonitorOnlyIfWatched = document.querySelector('#UnmonitorOnlyIfWatched').checked;
                    config.MinimumWatchPercentage = parseInt(document.querySelector('#MinimumWatchPercentage').value || 90, 10);
                    config.UnmonitorAfterUpgrade = document.querySelector('#UnmonitorAfterUpgrade').checked;

                    // Save script settings
                    config.ScriptSettings = JellyPyConfig.scriptSettings;

                    ApiClient.updatePluginConfiguration(JellyPyConfig.pluginUniqueId, config).then(function (result) {
                        Dashboard.processPluginConfigurationUpdateResult(result);
                    });

                    e.preventDefault();
                    return false;
                });
        </script>
    </div>
</body>
</html>
